<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Transition Display System - Enhanced Version</title>

    <!-- React Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Twinkl Cursive Looped Fonts */
        @font-face {
            font-family: 'Twinkl Cursive Looped';
            src: url('/fonts/TwinklCursiveLooped-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Looped';
            src: url('/fonts/TwinklCursiveLooped-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Looped';
            src: url('/fonts/TwinklCursiveLooped-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Looped';
            src: url('/fonts/TwinklCursiveLooped-Semibold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Looped';
            src: url('/fonts/TwinklCursiveLooped-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        /* Twinkl Cursive Unlooped Fonts */
        @font-face {
            font-family: 'Twinkl Cursive Unlooped';
            src: url('/fonts/TwinklCursiveUnlooped-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Unlooped';
            src: url('/fonts/TwinklCursiveUnlooped-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Unlooped';
            src: url('/fonts/TwinklCursiveUnlooped-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Unlooped';
            src: url('/fonts/TwinklCursiveUnlooped-Semibold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Cursive Unlooped';
            src: url('/fonts/TwinklCursiveUnlooped-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        /* Twinkl Precursive Fonts */
        @font-face {
            font-family: 'Twinkl Precursive';
            src: url('/fonts/TwinklPrecursive-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Precursive';
            src: url('/fonts/TwinklPrecursive-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Precursive';
            src: url('/fonts/TwinklPrecursive-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Precursive';
            src: url('/fonts/TwinklPrecursive-Semibold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Twinkl Precursive';
            src: url('/fonts/TwinklPrecursive-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #root {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100%;
        }

        /* Fix Lucide icon click areas */
        i[data-lucide] {
            display: inline-block;
            pointer-events: none;
        }

        i[data-lucide] svg {
            pointer-events: none;
        }

        button, a, label {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;

        const TimelineTaskSystem = () => {
            // State management
            const [currentTime, setCurrentTime] = useState(new Date());
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState('');
            const [viewMode, setViewMode] = useState('display');

            const [timelineConfig, setTimelineConfig] = useState({
                startTime: '09:00',
                endTime: '15:00',
                tasks: [
                    { id: 1, type: 'text', content: 'Morning Circle', duration: 30, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 2, type: 'text', content: 'Math Activity', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 3, type: 'text', content: 'Snack Time', duration: 15, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 4, type: 'text', content: 'Reading', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 5, type: 'text', content: 'Outdoor Play', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                ]
            });

            // School-related icon library
            const iconLibrary = [
                { id: 'book', name: 'Book', icon: 'book-open' },
                { id: 'pencil', name: 'Pencil', icon: 'pencil' },
                { id: 'calculator', name: 'Calculator', icon: 'calculator' },
                { id: 'palette', name: 'Art', icon: 'palette' },
                { id: 'music', name: 'Music', icon: 'music' },
                { id: 'flask', name: 'Science', icon: 'flask-conical' },
                { id: 'apple', name: 'Snack', icon: 'apple' },
                { id: 'utensils', name: 'Lunch', icon: 'utensils' },
                { id: 'running', name: 'PE/Sports', icon: 'person-standing' },
                { id: 'tree', name: 'Outdoor', icon: 'trees' },
                { id: 'computer', name: 'Computer', icon: 'monitor' },
                { id: 'users', name: 'Group Work', icon: 'users' },
                { id: 'sun', name: 'Morning', icon: 'sun' },
                { id: 'moon', name: 'Afternoon', icon: 'moon' },
                { id: 'home', name: 'Home Time', icon: 'home' },
                { id: 'bus', name: 'Bus', icon: 'bus' },
                { id: 'backpack', name: 'Backpack', icon: 'backpack' },
                { id: 'circle', name: 'Circle Time', icon: 'circle-dot' },
                { id: 'brain', name: 'Thinking', icon: 'brain' },
                { id: 'hand', name: 'Hand Raise', icon: 'hand' },
                { id: 'star', name: 'Star/Award', icon: 'star' },
                { id: 'heart', name: 'Wellness', icon: 'heart' },
                { id: 'globe', name: 'Geography', icon: 'globe' },
                { id: 'language', name: 'Language', icon: 'languages' },
            ];

            const [showTaskEditModal, setShowTaskEditModal] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const scrollContainerRef = useRef(null);
            const [isDragging, setIsDragging] = useState(false);
            const [startX, setStartX] = useState(0);
            const [scrollLeft, setScrollLeft] = useState(0);

            const [templates, setTemplates] = useState([{
                id: 'default',
                name: 'Standard School Day',
                startTime: '09:00',
                endTime: '15:00',
                tasks: [
                    { id: 1, type: 'text', content: 'Morning Circle', duration: 30, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 2, type: 'text', content: 'Math Activity', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 3, type: 'text', content: 'Snack Time', duration: 15, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 4, type: 'text', content: 'Reading', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                    { id: 5, type: 'text', content: 'Outdoor Play', duration: 45, imageUrl: null, icon: null, width: 200, height: 160 },
                ]
            }]);

            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [selectedTemplate, setSelectedTemplate] = useState(null);
            const [showSetupWizard, setShowSetupWizard] = useState(false);
            const [setupStep, setSetupStep] = useState(1);

            const [setupData, setSetupData] = useState({
                schoolName: '',
                className: '',
                teacherName: '',
                deviceName: '',
                setupComplete: false
            });

            const [displaySettings, setDisplaySettings] = useState({
                width: 2560,
                height: 1080,
                scale: 100,
                mode: 'horizontal', // 'horizontal', 'multi-row', or 'auto-pan'
                rows: 1,
                pathDirection: 'sequential', // 'sequential' or 'snake'
                transitionType: 'progress-line', // 'progress-line' or 'mascot'
                mascotImage: null,
                topBannerImage: null,
                bottomBannerImage: null,
                showClock: false, // For auto-pan mode
                autoPanTileHeight: 60 // Height percentage for auto-pan tiles (% of display height)
            });

            const [showDisplaySettings, setShowDisplaySettings] = useState(false);
            const [taskOverflowWarning, setTaskOverflowWarning] = useState(false);
            const [isEditingLayout, setIsEditingLayout] = useState(true);
            const [resizingTask, setResizingTask] = useState(null);

            // THEME SYSTEM STATE
            const [currentTheme, setCurrentTheme] = useState('ocean-calm');
            const [customThemes, setCustomThemes] = useState([]);
            const [showThemeSelector, setShowThemeSelector] = useState(false);
            const [showThemeEditor, setShowThemeEditor] = useState(false);
            const [editingTheme, setEditingTheme] = useState(null);

            // PRESET THEMES CONFIGURATION
            const presetThemes = {
                'ocean-calm': {
                    id: 'ocean-calm',
                    name: 'Ocean Calm',
                    emoji: 'ðŸŒŠ',
                    bgGradientFrom: '#eff6ff', // blue-50
                    bgGradientTo: '#ccfbf1', // teal-100
                    cardRounded: 'rounded-2xl',
                    cardBorderColor: '#3b82f6', // blue-500
                    cardBorderWidth: '2px',
                    cardBgColor: '#ffffff',
                    fontWeight: '400',
                    fontTransform: 'none',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#3b82f6', // blue-500
                    currentBgOverlay: 'rgba(191, 219, 254, 0.5)', // blue-200 with opacity
                    currentBorderEnhance: false,
                    tickPastColor: '#3b82f6', // blue-500
                    tickCurrentColor: '#06b6d4', // cyan-500
                    tickFutureColor: '#93c5fd', // blue-300
                    timeCardAccentColor: '#3b82f6', // blue-500
                    progressLineColors: { from: '#60a5fa', to: '#3b82f6' }, // blue-400 to blue-600
                    progressBgColor: '#d1d5db' // gray-300
                },
                'forest-friends': {
                    id: 'forest-friends',
                    name: 'Forest Friends',
                    emoji: 'ðŸŒ²',
                    bgGradientFrom: '#f0fdf4', // green-50
                    bgGradientTo: '#d1fae5', // emerald-100
                    cardRounded: 'rounded-xl',
                    cardBorderColor: '#166534', // green-800
                    cardBorderWidth: '2px',
                    cardBgColor: '#fefce8', // cream
                    fontWeight: '400',
                    fontTransform: 'none',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#166534',
                    currentBgOverlay: 'rgba(187, 247, 208, 0.5)', // green-200
                    currentBorderEnhance: false,
                    tickPastColor: '#166534',
                    tickCurrentColor: '#84cc16', // lime-500
                    tickFutureColor: '#86efac', // green-300
                    timeCardAccentColor: '#166534',
                    progressLineColors: { from: '#4ade80', to: '#16a34a' },
                    progressBgColor: '#d1d5db'
                },
                'sunshine-day': {
                    id: 'sunshine-day',
                    name: 'Sunshine Day',
                    emoji: 'â˜€ï¸',
                    bgGradientFrom: '#fefce8', // yellow-50
                    bgGradientTo: '#ffedd5', // orange-100
                    cardRounded: 'rounded-lg',
                    cardBorderColor: '#f97316', // orange-500
                    cardBorderWidth: '3px',
                    cardBgColor: '#ffffff',
                    fontWeight: '500',
                    fontTransform: 'none',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#fbbf24', // amber-400
                    currentBgOverlay: 'rgba(254, 240, 138, 0.6)', // yellow-200
                    currentBorderEnhance: false,
                    tickPastColor: '#f97316',
                    tickCurrentColor: '#fbbf24', // amber-400
                    tickFutureColor: '#fde047', // yellow-300
                    timeCardAccentColor: '#f97316',
                    progressLineColors: { from: '#fb923c', to: '#f97316' },
                    progressBgColor: '#d1d5db'
                },
                'pastel-dreams': {
                    id: 'pastel-dreams',
                    name: 'Pastel Dreams',
                    emoji: 'ðŸ’œ',
                    bgGradientFrom: '#faf5ff', // purple-50
                    bgGradientTo: '#fce7f3', // pink-50
                    cardRounded: 'rounded-3xl',
                    cardBorderColor: '#a78bfa', // purple-400
                    cardBorderWidth: '2px',
                    cardBgColor: '#ffffff',
                    fontWeight: '300',
                    fontTransform: 'none',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#a78bfa',
                    currentBgOverlay: 'rgba(233, 213, 255, 0.5)', // purple-200
                    currentBorderEnhance: false,
                    tickPastColor: '#a78bfa',
                    tickCurrentColor: '#f9a8d4', // pink-300
                    tickFutureColor: '#e9d5ff', // purple-200
                    timeCardAccentColor: '#a78bfa',
                    progressLineColors: { from: '#c084fc', to: '#a78bfa' },
                    progressBgColor: '#d1d5db'
                },
                'high-contrast': {
                    id: 'high-contrast',
                    name: 'High Contrast',
                    emoji: 'âš«',
                    bgGradientFrom: '#ffffff',
                    bgGradientTo: '#f3f4f6', // gray-100
                    cardRounded: 'rounded-md',
                    cardBorderColor: '#000000',
                    cardBorderWidth: '4px',
                    cardBgColor: '#ffffff',
                    fontWeight: '700',
                    fontTransform: 'none',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#000000',
                    currentBgOverlay: 'rgba(254, 240, 138, 1)', // yellow-200
                    currentBorderEnhance: true,
                    tickPastColor: '#000000',
                    tickCurrentColor: '#ef4444', // red-500
                    tickFutureColor: '#9ca3af', // gray-400
                    timeCardAccentColor: '#000000',
                    progressLineColors: { from: '#000000', to: '#000000' },
                    progressBgColor: '#d1d5db'
                },
                'superhero-power': {
                    id: 'superhero-power',
                    name: 'Superhero Power',
                    emoji: 'âš¡',
                    bgGradientFrom: '#fee2e2', // red-100
                    bgGradientTo: '#dbeafe', // blue-100
                    bgGradientVia: '#f3e8ff', // purple-100
                    cardRounded: 'rounded-sm',
                    cardBorderColor: '#dc2626', // red-600 (alternates with blue)
                    cardBorderColorAlt: '#2563eb', // blue-600
                    cardBorderWidth: '4px',
                    cardBgColor: '#ffffff',
                    fontWeight: '800',
                    fontTransform: 'uppercase',
                    fontFamily: 'sans-serif',
                    currentGlowColor: '#fef08a', // yellow-200
                    currentBgOverlay: 'rgba(254, 240, 138, 0.8)',
                    currentBorderEnhance: true,
                    currentShadow: true,
                    tickPastColor: '#dc2626',
                    tickCurrentColor: '#facc15', // yellow-400
                    tickFutureColor: '#2563eb',
                    timeCardAccentColor: '#dc2626',
                    timeCardAccentColorAlt: '#2563eb',
                    progressLineColors: { from: '#facc15', to: '#f59e0b' },
                    progressBgColor: '#d1d5db',
                    specialEffect: 'comic-shadow'
                }
            };

            // Clock update - update every 50ms for ultra-smooth animations (20 fps)
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 50);
                return () => clearInterval(timer);
            }, []);

            // Initialize Lucide icons after every render
            useEffect(() => {
                // Small delay to ensure DOM is ready
                const timer = setTimeout(() => {
                    if (window.lucide) {
                        window.lucide.createIcons();
                    }
                }, 10);
                return () => clearTimeout(timer);
            });

            // THEME HELPER FUNCTIONS
            const getActiveTheme = () => {
                if (presetThemes[currentTheme]) {
                    return presetThemes[currentTheme];
                }
                const customTheme = customThemes.find(t => t.id === currentTheme);
                return customTheme || presetThemes['ocean-calm'];
            };

            const getThemeName = () => {
                const theme = getActiveTheme();
                return theme.name;
            };

            const getThemeEmoji = () => {
                const theme = getActiveTheme();
                return theme.emoji || 'ðŸŽ¨';
            };

            // Helper to get font family with proper fallbacks
            const getFontFamily = (family) => {
                if (family === 'twinkl' || family === 'twinkl-looped') {
                    return "'Twinkl Cursive Looped', 'Comic Sans MS', cursive";
                } else if (family === 'twinkl-unlooped') {
                    return "'Twinkl Cursive Unlooped', 'Comic Sans MS', cursive";
                } else if (family === 'twinkl-precursive') {
                    return "'Twinkl Precursive', 'Comic Sans MS', cursive";
                } else if (family === 'cursive') {
                    return "cursive";
                } else {
                    return "sans-serif";
                }
            };

            // Helper to get font styling object (for Twinkl adjustments)
            const getFontStyle = (theme, baseFontSize) => {
                const isTwinkl = theme.fontFamily === 'twinkl' ||
                                 theme.fontFamily === 'twinkl-looped' ||
                                 theme.fontFamily === 'twinkl-unlooped' ||
                                 theme.fontFamily === 'twinkl-precursive';
                return {
                    fontWeight: theme.fontWeight,
                    textTransform: theme.fontTransform,
                    fontFamily: getFontFamily(theme.fontFamily || 'sans-serif'),
                    fontSize: isTwinkl ? `${baseFontSize * 1.1}px` : `${baseFontSize}px`,
                    letterSpacing: isTwinkl ? '0.5px' : 'normal',
                    lineHeight: isTwinkl ? '1.4' : 'normal'
                };
            };

            // Load from localStorage
            useEffect(() => {
                const savedTemplates = localStorage.getItem('taskTemplates');
                const savedConfig = localStorage.getItem('currentTimelineConfig');
                const savedSetup = localStorage.getItem('setupData');
                const savedDisplaySettings = localStorage.getItem('displaySettings');
                const savedTheme = localStorage.getItem('currentTheme');
                const savedCustomThemes = localStorage.getItem('customThemes');

                if (savedTemplates) {
                    const templates = JSON.parse(savedTemplates);
                    // Add default width/height/icon to old tasks
                    templates.forEach(template => {
                        template.tasks = template.tasks.map(task => ({
                            ...task,
                            width: task.width || 200,
                            height: task.height || 160,
                            icon: task.icon || null
                        }));
                    });
                    setTemplates(templates);
                }

                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    // Add default width/height/icon to old tasks
                    config.tasks = config.tasks.map(task => ({
                        ...task,
                        width: task.width || 200,
                        height: task.height || 160,
                        icon: task.icon || null
                    }));
                    setTimelineConfig(config);
                }

                if (savedSetup) {
                    setSetupData(JSON.parse(savedSetup));
                } else {
                    setShowSetupWizard(true);
                }

                if (savedDisplaySettings) {
                    const settings = JSON.parse(savedDisplaySettings);
                    // Update old 'ticks' to 'progress-line'
                    if (settings.transitionType === 'ticks') {
                        settings.transitionType = 'progress-line';
                    }
                    setDisplaySettings(settings);
                }

                if (savedTheme) {
                    setCurrentTheme(savedTheme);
                }

                if (savedCustomThemes) {
                    setCustomThemes(JSON.parse(savedCustomThemes));
                }
            }, []);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('currentTimelineConfig', JSON.stringify(timelineConfig));
            }, [timelineConfig]);

            useEffect(() => {
                localStorage.setItem('taskTemplates', JSON.stringify(templates));
            }, [templates]);

            useEffect(() => {
                localStorage.setItem('setupData', JSON.stringify(setupData));
            }, [setupData]);

            useEffect(() => {
                localStorage.setItem('displaySettings', JSON.stringify(displaySettings));
            }, [displaySettings]);

            useEffect(() => {
                localStorage.setItem('currentTheme', currentTheme);
            }, [currentTheme]);

            useEffect(() => {
                localStorage.setItem('customThemes', JSON.stringify(customThemes));
            }, [customThemes]);

            // Initialize Lucide icons
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            // Helper functions
            const getTotalDuration = () => {
                return timelineConfig.tasks.reduce((sum, task) => sum + task.duration, 0);
            };

            const calculateEndTime = () => {
                const [hours, minutes] = timelineConfig.startTime.split(':').map(Number);
                const totalMinutes = getTotalDuration();
                const endMinutes = hours * 60 + minutes + totalMinutes;
                const endHours = Math.floor(endMinutes / 60) % 24;
                const endMins = endMinutes % 60;
                return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
            };

            const calculateTaskWidth = (duration) => {
                const minTaskWidth = 200;
                const margin = 24;
                return minTaskWidth + margin;
            };

            const getMaxTasksForDisplay = () => {
                const availableWidth = displaySettings.mode === 'horizontal'
                    ? displaySettings.width - 100
                    : displaySettings.width - 100;
                const startEndWidth = 140 + 24;
                let remainingWidth = availableWidth - (startEndWidth * 2);
                let maxTasks = 0;

                for (let task of timelineConfig.tasks) {
                    const taskWidth = task.width || 200;
                    const transitionWidth = taskWidth * 1.5;
                    const totalWidth = taskWidth + transitionWidth;
                    if (remainingWidth >= totalWidth) {
                        remainingWidth -= totalWidth;
                        maxTasks++;
                    } else {
                        break;
                    }
                }

                if (displaySettings.mode === 'multi-row') {
                    const maxRows = getMaxRowsForDisplay();
                    return maxTasks * maxRows;
                }

                return maxTasks;
            };

            const getMaxRowsForDisplay = () => {
                const availableHeight = displaySettings.height - 200;
                const rowHeight = 250;
                return Math.max(1, Math.floor(availableHeight / rowHeight));
            };


            const getCurrentTaskProgress = () => {
                const now = currentTime;
                // Calculate elapsed time in seconds for smooth animation
                const currentSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

                const [startHour, startMinute] = timelineConfig.startTime.split(':').map(Number);
                const startSeconds = startHour * 3600 + startMinute * 60;

                let elapsedSeconds = currentSeconds - startSeconds;

                if (elapsedSeconds < 0) return { currentTaskIndex: -1, elapsedInTask: 0 };

                let accumulatedTime = 0;
                for (let i = 0; i < timelineConfig.tasks.length; i++) {
                    const taskDurationSeconds = timelineConfig.tasks[i].duration * 60;
                    if (elapsedSeconds < accumulatedTime + taskDurationSeconds) {
                        return {
                            currentTaskIndex: i,
                            elapsedInTask: (elapsedSeconds - accumulatedTime) / 60 // Return in minutes for display
                        };
                    }
                    accumulatedTime += taskDurationSeconds;
                }

                return { currentTaskIndex: timelineConfig.tasks.length, elapsedInTask: 0 };
            };

            // Event handlers
            const handleLogin = () => {
                if (password === 'admin123') {
                    setIsAdmin(true);
                    setShowLogin(false);
                    setPassword('');
                } else {
                    alert('Invalid password. Use: admin123');
                }
            };

            const handleAddTask = () => {
                const newTask = {
                    id: Date.now(),
                    type: 'text',
                    content: 'New Task',
                    duration: 30,
                    imageUrl: null,
                    icon: null,
                    width: 200,
                    height: 160
                };
                const newTasks = [...timelineConfig.tasks, newTask];
                setTimelineConfig({
                    ...timelineConfig,
                    tasks: newTasks
                });

                // Check if we're exceeding display width
                setTimeout(() => {
                    const maxTasks = getMaxTasksForDisplay();
                    if (newTasks.length > maxTasks) {
                        setTaskOverflowWarning(true);
                        setTimeout(() => setTaskOverflowWarning(false), 5000);
                    }
                }, 100);
            };

            const handleDeleteTask = (id) => {
                setTimelineConfig({
                    ...timelineConfig,
                    tasks: timelineConfig.tasks.filter(task => task.id !== id)
                });
            };

            const handleSaveTask = (updatedTask) => {
                setTimelineConfig({
                    ...timelineConfig,
                    tasks: timelineConfig.tasks.map(task =>
                        task.id === updatedTask.id ? updatedTask : task
                    )
                });
                setEditingTask(null);
            };

            const handleImageUpload = (taskId, event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const updatedTasks = timelineConfig.tasks.map(task =>
                            task.id === taskId
                                ? { ...task, type: 'image', imageUrl: reader.result }
                                : task
                        );
                        setTimelineConfig({ ...timelineConfig, tasks: updatedTasks });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleMascotUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setDisplaySettings({ ...displaySettings, mascotImage: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleMouseDown = (e) => {
                if (!scrollContainerRef.current) return;
                setIsDragging(true);
                setStartX(e.pageX - scrollContainerRef.current.offsetLeft);
                setScrollLeft(scrollContainerRef.current.scrollLeft);
            };

            const handleMouseMove = (e) => {
                if (!isDragging || !scrollContainerRef.current) return;
                e.preventDefault();
                const x = e.pageX - scrollContainerRef.current.offsetLeft;
                const walk = (x - startX) * 2;
                scrollContainerRef.current.scrollLeft = scrollLeft - walk;
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            const handleSaveAsTemplate = () => {
                if (newTemplateName.trim()) {
                    const newTemplate = {
                        id: Date.now().toString(),
                        name: newTemplateName,
                        startTime: timelineConfig.startTime,
                        endTime: timelineConfig.endTime,
                        tasks: timelineConfig.tasks.map(task => ({ ...task }))
                    };
                    setTemplates([...templates, newTemplate]);
                    setNewTemplateName('');
                    setShowTemplateModal(false);
                    alert('Template saved successfully!');
                }
            };

            const handleLoadTemplate = (template) => {
                if (confirm(`Load "${template.name}"? This will replace your current schedule.`)) {
                    setTimelineConfig({
                        startTime: template.startTime,
                        endTime: template.endTime,
                        tasks: template.tasks.map(task => ({ ...task, id: Date.now() + Math.random() }))
                    });
                    setSelectedTemplate(template.id);
                }
            };

            const handleDeleteTemplate = (templateId) => {
                if (confirm('Delete this template? This cannot be undone.')) {
                    setTemplates(templates.filter(t => t.id !== templateId));
                }
            };

            const handleCompleteSetup = () => {
                if (setupData.schoolName && setupData.className && setupData.teacherName) {
                    setSetupData({ ...setupData, setupComplete: true });
                    setShowSetupWizard(false);
                    alert('Setup complete! You can now configure your daily schedule.');
                } else {
                    alert('Please complete all required fields.');
                }
            };

            const handleSkipSetup = () => {
                setSetupData({
                    schoolName: 'Not Configured',
                    className: 'Not Configured',
                    teacherName: 'Not Configured',
                    deviceName: 'Display 1',
                    setupComplete: true
                });
                setShowSetupWizard(false);
            };

            const handleUpdateTaskSize = (taskId, width, height) => {
                setTimelineConfig({
                    ...timelineConfig,
                    tasks: timelineConfig.tasks.map(task =>
                        task.id === taskId ? { ...task, width, height } : task
                    )
                });
            };

            const handleEditTask = (task) => {
                setEditingTask({ ...task });
                setShowTaskEditModal(true);
            };

            const handleSaveTaskFromModal = () => {
                if (!editingTask) return;

                setTimelineConfig(prevConfig => ({
                    ...prevConfig,
                    tasks: prevConfig.tasks.map(task =>
                        task.id === editingTask.id ? editingTask : task
                    )
                }));

                setShowTaskEditModal(false);
                setEditingTask(null);
            };

            const handleCancelEdit = () => {
                setShowTaskEditModal(false);
                setEditingTask(null);
            };

            // DISPLAY VIEW COMPONENTS
            const ProgressLine = ({ taskDuration, elapsed, isPast, isActive, lineWidth }) => {
                const progressPercentage = isPast ? 100 : isActive ? Math.min(100, (elapsed / taskDuration) * 100) : 0;
                const theme = getActiveTheme();
                const dotColor = isPast ? theme.tickPastColor : isActive ? theme.tickCurrentColor : theme.tickFutureColor;

                return (
                    <div
                        className="relative flex items-center px-4"
                        style={{ minWidth: `${lineWidth}px`, width: `${lineWidth}px` }}
                    >
                        <div
                            className="relative w-full h-3 rounded-full overflow-hidden"
                            style={{ backgroundColor: theme.progressBgColor }}
                        >
                            <div
                                className="absolute top-0 left-0 h-full rounded-full"
                                style={{
                                    background: `linear-gradient(to right, ${theme.progressLineColors.from}, ${theme.progressLineColors.to})`,
                                    width: `${progressPercentage}%`,
                                    transition: 'none'
                                }}
                            />

                            {(isActive || isPast) && (
                                <div
                                    className="absolute top-1/2 transform -translate-y-1/2 -translate-x-1/2"
                                    style={{
                                        left: `${progressPercentage}%`,
                                        transition: 'none'
                                    }}
                                >
                                    <div
                                        className="w-6 h-6 bg-white rounded-full shadow-lg"
                                        style={{ border: `4px solid ${dotColor}` }}
                                    ></div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const MascotRoad = ({ taskDuration, elapsed, isPast, isActive, mascotImg, roadWidth }) => {
                const progressPercentage = isPast ? 100 : isActive ? Math.min(100, (elapsed / taskDuration) * 100) : 0;
                const numDashes = Math.max(6, Math.floor(roadWidth / 50));

                return (
                    <div
                        className="relative flex items-center px-4"
                        style={{ minWidth: `${roadWidth}px`, width: `${roadWidth}px` }}
                    >
                        <div className="relative w-full h-8 bg-gray-400 rounded-full overflow-hidden">
                            <div className="absolute inset-0 flex items-center justify-around">
                                {Array.from({ length: numDashes }).map((_, i) => (
                                    <div key={i} className="w-4 h-1 bg-white rounded-full" />
                                ))}
                            </div>

                            <div
                                className="absolute top-0 left-0 h-full bg-green-300"
                                style={{
                                    width: `${progressPercentage}%`,
                                    transition: 'none'
                                }}
                            />

                            {(isActive || isPast) && (
                                <div
                                    className="absolute top-1/2 transform -translate-y-1/2"
                                    style={{
                                        left: `calc(${progressPercentage}% - 20px)`,
                                        transition: 'none'
                                    }}
                                >
                                    {mascotImg ? (
                                        <img src={mascotImg} alt="Mascot" className="w-10 h-10 object-contain" />
                                    ) : (
                                        <div className="text-3xl">ðŸš—</div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Calculate these values regardless of admin state (needed for preview)
            const { currentTaskIndex, elapsedInTask } = getCurrentTaskProgress();
            const totalDuration = getTotalDuration();
            const scaleFactor = displaySettings.scale / 100;

            // Multi-row timeline rendering function (needed in both display and admin preview)
            const renderTimelineRow = (tasks, startIdx, endIdx, rowIndex) => {
                const isSnake = displaySettings.pathDirection === 'snake';
                const isReverse = isSnake && rowIndex % 2 === 1;
                const rowTasks = tasks.slice(startIdx, endIdx);
                if (isReverse) rowTasks.reverse();

                const showStartClock = !isReverse && rowIndex === 0;
                const showEndClock = (isReverse && rowIndex === displaySettings.rows - 1) || (!isReverse && endIdx >= timelineConfig.tasks.length);
                const rowTheme = getActiveTheme();

                return (
                    <div className="flex items-center gap-4 w-full" key={rowIndex}>
                        {showStartClock && (
                            <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-4 min-w-[120px] flex-shrink-0" style={{ borderLeft: `4px solid ${rowTheme.timeCardAccentColor}` }}>
                                <i data-lucide="clock" className="w-10 h-10 mb-2" style={{ color: rowTheme.timeCardAccentColor }}></i>
                                <div className="text-4xl font-bold text-gray-800">{timelineConfig.startTime}</div>
                                <div className="text-sm text-gray-600 mt-1">Start</div>
                            </div>
                        )}

                        {rowTasks.map((task, localIndex) => {
                            const actualIndex = isReverse ? endIdx - 1 - localIndex : startIdx + localIndex;
                            const isCurrentTask = actualIndex === currentTaskIndex;
                            const isPastTask = actualIndex < currentTaskIndex;
                            const taskWidth = task.width || 200;
                            const taskHeight = task.height || 160;
                            const transitionWidth = taskWidth * 1.2;
                            const taskCardBorder = rowTheme.cardBorderColorAlt && actualIndex % 2 === 1
                                ? rowTheme.cardBorderColorAlt
                                : rowTheme.cardBorderColor;

                            return (
                                <Fragment key={task.id}>
                                    <div
                                        className={`flex flex-col items-center justify-center ${rowTheme.cardRounded} shadow-lg p-4 transition-all duration-1000 ${isPastTask ? 'opacity-60' : ''} ${isCurrentTask ? 'scale-105' : ''}`}
                                        style={{
                                            minWidth: `${taskWidth * 0.8}px`,
                                            width: `${taskWidth * 0.8}px`,
                                            minHeight: `${taskHeight * 0.8}px`,
                                            backgroundColor: isCurrentTask ? rowTheme.currentBgOverlay : (isPastTask ? '#f3f4f6' : rowTheme.cardBgColor),
                                            border: isCurrentTask && rowTheme.currentBorderEnhance
                                                ? `${parseInt(rowTheme.cardBorderWidth) * 1.5}px solid ${rowTheme.currentGlowColor}`
                                                : `${rowTheme.cardBorderWidth} solid ${taskCardBorder}`,
                                            boxShadow: isCurrentTask ? `0 0 25px ${rowTheme.currentGlowColor}` : undefined
                                        }}
                                    >
                                        {task.type === 'image' && task.imageUrl ? (
                                            <img
                                                src={task.imageUrl}
                                                alt={task.content}
                                                className="object-cover rounded-lg mb-2"
                                                style={{
                                                    width: `${Math.min(taskWidth * 0.6, 96)}px`,
                                                    height: `${Math.min(taskHeight * 0.5, 96)}px`
                                                }}
                                            />
                                        ) : (
                                            <>
                                                {task.icon && iconLibrary.find(i => i.id === task.icon)?.icon && (
                                                    <i
                                                        data-lucide={iconLibrary.find(i => i.id === task.icon).icon}
                                                        className="text-indigo-600 mb-2"
                                                        style={{ width: `${Math.min(taskWidth * 0.4, 64)}px`, height: `${Math.min(taskWidth * 0.4, 64)}px` }}
                                                    ></i>
                                                )}
                                                <div
                                                    className="text-gray-800 text-center mb-2"
                                                    style={getFontStyle(rowTheme, Math.min(taskWidth / 6, 28))}
                                                >
                                                    {task.content}
                                                </div>
                                            </>
                                        )}
                                        <div
                                            className="text-gray-600"
                                            style={{ fontSize: `${Math.min(taskWidth / 12, 18)}px` }}
                                        >
                                            {task.duration} min
                                        </div>
                                    </div>

                                    {displaySettings.transitionType === 'mascot' ? (
                                        <MascotRoad
                                            taskDuration={task.duration}
                                            elapsed={isCurrentTask ? elapsedInTask : 0}
                                            isPast={isPastTask}
                                            isActive={isCurrentTask}
                                            mascotImg={displaySettings.mascotImage}
                                            roadWidth={transitionWidth}
                                        />
                                    ) : (
                                        <ProgressLine
                                            taskDuration={task.duration}
                                            elapsed={isCurrentTask ? elapsedInTask : 0}
                                            isPast={isPastTask}
                                            isActive={isCurrentTask}
                                            lineWidth={transitionWidth}
                                        />
                                    )}
                                </Fragment>
                            );
                        })}

                        {showEndClock && (
                            <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-4 min-w-[120px] flex-shrink-0" style={{ borderLeft: `4px solid ${rowTheme.timeCardAccentColorAlt || rowTheme.timeCardAccentColor}` }}>
                                <i data-lucide="clock" className="w-10 h-10 mb-2" style={{ color: rowTheme.timeCardAccentColorAlt || rowTheme.timeCardAccentColor }}></i>
                                <div className="text-4xl font-bold text-gray-800">{calculateEndTime()}</div>
                                <div className="text-sm text-gray-600 mt-1">End</div>
                            </div>
                        )}
                    </div>
                );
            };

            if (!isAdmin) {

                // Setup Wizard - keeping original
                if (showSetupWizard) {
                    return (
                        <div className="w-full h-screen bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center p-8">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8">
                                <div className="flex items-center justify-between mb-8">
                                    <div className={`flex items-center justify-center w-10 h-10 rounded-full ${setupStep >= 1 ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-600'} font-bold`}>1</div>
                                    <div className={`flex-1 h-1 mx-2 ${setupStep >= 2 ? 'bg-indigo-600' : 'bg-gray-300'}`}></div>
                                    <div className={`flex items-center justify-center w-10 h-10 rounded-full ${setupStep >= 2 ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-600'} font-bold`}>2</div>
                                    <div className={`flex-1 h-1 mx-2 ${setupStep >= 3 ? 'bg-indigo-600' : 'bg-gray-300'}`}></div>
                                    <div className={`flex items-center justify-center w-10 h-10 rounded-full ${setupStep >= 3 ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-600'} font-bold`}>3</div>
                                </div>

                                {setupStep === 1 && (
                                    <div className="text-center">
                                        <div className="text-6xl mb-6">ðŸŽ“</div>
                                        <h1 className="text-4xl font-bold text-gray-800 mb-4">Welcome to Task Transition Display</h1>
                                        <p className="text-xl text-gray-600 mb-8">
                                            Let's set up your display in just a few steps. This will help personalize the system for your classroom.
                                        </p>
                                        <div className="flex gap-4 justify-center">
                                            <button
                                                onClick={() => setSetupStep(2)}
                                                className="px-8 py-4 bg-indigo-600 text-white text-lg rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
                                            >
                                                Get Started
                                            </button>
                                            <button
                                                onClick={handleSkipSetup}
                                                className="px-8 py-4 bg-gray-200 text-gray-700 text-lg rounded-lg hover:bg-gray-300 transition-colors font-semibold"
                                            >
                                                Skip Setup
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {setupStep === 2 && (
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800 mb-6">School & Classroom Information</h2>
                                        <div className="space-y-4 mb-8">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">School Name *</label>
                                                <input
                                                    type="text"
                                                    placeholder="e.g., Riverside Elementary School"
                                                    value={setupData.schoolName}
                                                    onChange={(e) => setSetupData({ ...setupData, schoolName: e.target.value })}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Class/Room Name *</label>
                                                <input
                                                    type="text"
                                                    placeholder="e.g., Room 5A, Reception Class, Year 3"
                                                    value={setupData.className}
                                                    onChange={(e) => setSetupData({ ...setupData, className: e.target.value })}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Lead Teacher Name *</label>
                                                <input
                                                    type="text"
                                                    placeholder="e.g., Mrs. Johnson"
                                                    value={setupData.teacherName}
                                                    onChange={(e) => setSetupData({ ...setupData, teacherName: e.target.value })}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Device Name (Optional)</label>
                                                <input
                                                    type="text"
                                                    placeholder="e.g., Main Display, Back Wall Screen"
                                                    value={setupData.deviceName}
                                                    onChange={(e) => setSetupData({ ...setupData, deviceName: e.target.value })}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex gap-4">
                                            <button
                                                onClick={() => setSetupStep(1)}
                                                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
                                            >
                                                Back
                                            </button>
                                            <button
                                                onClick={() => setSetupStep(3)}
                                                className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
                                            >
                                                Continue
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {setupStep === 3 && (
                                    <div>
                                        <h2 className="text-3xl font-bold text-gray-800 mb-6">Quick Tips for Success</h2>
                                        <div className="space-y-4 mb-8">
                                            <div className="flex gap-4 p-4 bg-blue-50 rounded-lg">
                                                <div className="text-3xl">ðŸ‘ï¸</div>
                                                <div>
                                                    <h3 className="font-bold text-gray-800 mb-1">High Visibility</h3>
                                                    <p className="text-gray-600">Position the display where all students can easily see it from their seats.</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-4 p-4 bg-green-50 rounded-lg">
                                                <div className="text-3xl">ðŸ“¸</div>
                                                <div>
                                                    <h3 className="font-bold text-gray-800 mb-1">Use Pictures</h3>
                                                    <p className="text-gray-600">Visual learners benefit from images. Upload pictures of activities in the admin panel.</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-4 p-4 bg-purple-50 rounded-lg">
                                                <div className="text-3xl">â°</div>
                                                <div>
                                                    <h3 className="font-bold text-gray-800 mb-1">Consistent Timing</h3>
                                                    <p className="text-gray-600">Keep transition times consistent daily to help children predict their schedule.</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-4 p-4 bg-yellow-50 rounded-lg">
                                                <div className="text-3xl">ðŸ’¾</div>
                                                <div>
                                                    <h3 className="font-bold text-gray-800 mb-1">Save Templates</h3>
                                                    <p className="text-gray-600">Create templates for different day types (full day, short day, special events).</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-indigo-50 border-l-4 border-indigo-600 p-4 mb-6 rounded">
                                            <p className="text-indigo-900">
                                                <strong>Admin Access:</strong> Click the settings icon (âš™ï¸) in the top-right corner to manage tasks.
                                                Default password: <code className="bg-white px-2 py-1 rounded">admin123</code>
                                            </p>
                                        </div>
                                        <div className="flex gap-4">
                                            <button
                                                onClick={() => setSetupStep(2)}
                                                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
                                            >
                                                Back
                                            </button>
                                            <button
                                                onClick={handleCompleteSetup}
                                                className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-lg"
                                            >
                                                Complete Setup ðŸŽ‰
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                // Main Display View
                const activeTheme = getActiveTheme();

                return (
                    <div
                        className="relative w-screen h-screen overflow-hidden"
                        style={{
                            background: activeTheme.bgGradientVia
                                ? `linear-gradient(to bottom, ${activeTheme.bgGradientFrom}, ${activeTheme.bgGradientVia}, ${activeTheme.bgGradientTo})`
                                : `linear-gradient(to bottom, ${activeTheme.bgGradientFrom}, ${activeTheme.bgGradientTo})`
                        }}
                    >
                        <button
                            onClick={() => setShowLogin(true)}
                            className="absolute top-4 right-4 px-6 py-3 bg-white rounded-lg shadow-lg hover:shadow-xl transition-all hover:bg-gray-50 z-50 flex items-center gap-2 font-semibold text-gray-700"
                            aria-label="Settings"
                        >
                            <span className="text-2xl">âš™ï¸</span>
                            <span>Admin</span>
                        </button>

                        <div
                            className="absolute top-0 left-0"
                            style={{
                                background: activeTheme.bgGradientVia
                                    ? `linear-gradient(to bottom, ${activeTheme.bgGradientFrom}, ${activeTheme.bgGradientVia}, ${activeTheme.bgGradientTo})`
                                    : `linear-gradient(to bottom, ${activeTheme.bgGradientFrom}, ${activeTheme.bgGradientTo})`,
                                width: `${displaySettings.width}px`,
                                height: `${displaySettings.height}px`,
                                transform: `scale(${scaleFactor})`,
                                transformOrigin: 'top left'
                            }}
                        >

                        {showLogin && (
                            <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-8 w-96 shadow-2xl">
                                    <h2 className="text-2xl font-bold mb-6 text-gray-800">Admin Access</h2>
                                    <input
                                        type="password"
                                        placeholder="Enter Password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg"
                                    />
                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleLogin}
                                            className="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
                                        >
                                            Login
                                        </button>
                                        <button
                                            onClick={() => setShowLogin(false)}
                                            className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                    <p className="mt-4 text-sm text-gray-600 text-center">Password: admin123</p>
                                </div>
                            </div>
                        )}

                        <div className="w-full h-full flex items-center px-8 py-16">
                            {displaySettings.mode === 'horizontal' ? (
                                <div className="w-full h-full flex items-center gap-4 overflow-x-auto">
                                    <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-6 min-w-[140px]" style={{ borderLeft: `6px solid ${activeTheme.timeCardAccentColor}` }}>
                                        <i data-lucide="clock" className="w-12 h-12 mb-3" style={{ color: activeTheme.timeCardAccentColor }}></i>
                                        <div className="text-5xl font-bold text-gray-800">{timelineConfig.startTime}</div>
                                        <div className="text-lg text-gray-600 mt-2">Start</div>
                                    </div>

                                    {timelineConfig.tasks.map((task, index) => {
                                        const isCurrentTask = index === currentTaskIndex;
                                        const isPastTask = index < currentTaskIndex;
                                        const taskWidth = task.width || 200;
                                        const taskHeight = task.height || 160;
                                        const transitionWidth = taskWidth * 1.5;

                                        const taskCardBorder = activeTheme.cardBorderColorAlt && index % 2 === 1
                                            ? activeTheme.cardBorderColorAlt
                                            : activeTheme.cardBorderColor;

                                        return (
                                            <Fragment key={task.id}>
                                                <div
                                                    className={`flex flex-col items-center justify-center ${activeTheme.cardRounded} shadow-lg p-6 transition-all duration-1000 ${isPastTask ? 'opacity-60' : ''} ${isCurrentTask ? 'scale-105' : ''}`}
                                                    style={{
                                                        minWidth: `${taskWidth}px`,
                                                        width: `${taskWidth}px`,
                                                        minHeight: `${taskHeight}px`,
                                                        backgroundColor: isCurrentTask ? activeTheme.currentBgOverlay : (isPastTask ? '#f3f4f6' : activeTheme.cardBgColor),
                                                        border: isCurrentTask && activeTheme.currentBorderEnhance
                                                            ? `${parseInt(activeTheme.cardBorderWidth) * 1.5}px solid ${activeTheme.currentGlowColor}`
                                                            : `${activeTheme.cardBorderWidth} solid ${taskCardBorder}`,
                                                        boxShadow: isCurrentTask ? `0 0 30px ${activeTheme.currentGlowColor}` : undefined
                                                    }}
                                                >
                                                    {task.type === 'image' && task.imageUrl ? (
                                                        <img
                                                            src={task.imageUrl}
                                                            alt={task.content}
                                                            className="object-cover rounded-lg mb-3"
                                                            style={{
                                                                width: `${Math.min(taskWidth * 0.7, 128)}px`,
                                                                height: `${Math.min(taskHeight * 0.6, 128)}px`
                                                            }}
                                                        />
                                                    ) : (
                                                        <>
                                                            {task.icon && iconLibrary.find(i => i.id === task.icon)?.icon && (
                                                                <i
                                                                    data-lucide={iconLibrary.find(i => i.id === task.icon).icon}
                                                                    className="text-indigo-600 mb-3"
                                                                    style={{ width: `${Math.min(taskWidth * 0.5, 80)}px`, height: `${Math.min(taskWidth * 0.5, 80)}px` }}
                                                                ></i>
                                                            )}
                                                            <div
                                                                className="text-gray-800 text-center mb-3"
                                                                style={getFontStyle(activeTheme, Math.min(taskWidth / 5, 36))}
                                                            >
                                                                {task.content}
                                                            </div>
                                                        </>
                                                    )}
                                                    <div
                                                        className="text-gray-600"
                                                        style={{ fontSize: `${Math.min(taskWidth / 10, 20)}px` }}
                                                    >
                                                        {task.duration} min
                                                    </div>
                                                </div>

                                                {displaySettings.transitionType === 'mascot' ? (
                                                    <MascotRoad
                                                        taskDuration={task.duration}
                                                        elapsed={isCurrentTask ? elapsedInTask : 0}
                                                        isPast={isPastTask}
                                                        isActive={isCurrentTask}
                                                        mascotImg={displaySettings.mascotImage}
                                                        roadWidth={transitionWidth}
                                                    />
                                                ) : (
                                                    <ProgressLine
                                                        taskDuration={task.duration}
                                                        elapsed={isCurrentTask ? elapsedInTask : 0}
                                                        isPast={isPastTask}
                                                        isActive={isCurrentTask}
                                                        lineWidth={transitionWidth}
                                                    />
                                                )}
                                            </Fragment>
                                        );
                                    })}

                                    <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-6 min-w-[140px]" style={{ borderLeft: `6px solid ${activeTheme.timeCardAccentColorAlt || activeTheme.timeCardAccentColor}` }}>
                                        <i data-lucide="clock" className="w-12 h-12 mb-3" style={{ color: activeTheme.timeCardAccentColorAlt || activeTheme.timeCardAccentColor }}></i>
                                        <div className="text-5xl font-bold text-gray-800">{calculateEndTime()}</div>
                                        <div className="text-lg text-gray-600 mt-2">End</div>
                                    </div>
                                </div>
                            ) : displaySettings.mode === 'multi-row' ? (
                                <div className="w-full h-full flex flex-col justify-evenly">
                                    {Array.from({ length: displaySettings.rows }).map((_, rowIndex) => {
                                        const tasksPerRow = Math.ceil(timelineConfig.tasks.length / displaySettings.rows);
                                        const startIdx = rowIndex * tasksPerRow;
                                        const endIdx = Math.min((rowIndex + 1) * tasksPerRow, timelineConfig.tasks.length);

                                        if (startIdx >= timelineConfig.tasks.length) return null;

                                        return renderTimelineRow(timelineConfig.tasks, startIdx, endIdx, rowIndex);
                                    })}
                                </div>
                            ) : (
                                /* Auto-Pan Mode */
                                <div className="w-full h-full flex flex-col">
                                    {/* Top Banner */}
                                    {(displaySettings.topBannerImage || displaySettings.showClock) && (
                                        <div className="flex items-center justify-center py-4 bg-gradient-to-r from-indigo-500 to-purple-600">
                                            {displaySettings.topBannerImage && (
                                                <img
                                                    src={displaySettings.topBannerImage}
                                                    alt="Top Banner"
                                                    className="max-h-20 object-contain"
                                                />
                                            )}
                                            {displaySettings.showClock && (
                                                <div className="text-4xl font-bold text-white ml-8">
                                                    {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Main Task Display Area - Current, Transition, Next */}
                                    <div className="flex-1 flex items-center justify-center px-8">
                                        <div className="w-full flex items-stretch gap-4" style={{ height: `${displaySettings.autoPanTileHeight}%` }}>
                                            {/* Current Task - 1/5 width */}
                                            <div
                                                className={`flex flex-col items-center justify-center ${activeTheme.cardRounded} shadow-2xl p-8`}
                                                style={{
                                                    flex: '1',
                                                    backgroundColor: activeTheme.currentBgOverlay,
                                                    border: activeTheme.currentBorderEnhance
                                                        ? `${parseInt(activeTheme.cardBorderWidth) * 2}px solid ${activeTheme.currentGlowColor}`
                                                        : `${parseInt(activeTheme.cardBorderWidth) * 2}px solid ${activeTheme.cardBorderColor}`,
                                                    boxShadow: `0 0 40px ${activeTheme.currentGlowColor}`
                                                }}
                                            >
                                                {timelineConfig.tasks[currentTaskIndex] ? (
                                                    <>
                                                        <div className="text-sm font-semibold mb-4" style={{ color: activeTheme.currentGlowColor }}>CURRENT TASK</div>
                                                        {timelineConfig.tasks[currentTaskIndex].type === 'image' && timelineConfig.tasks[currentTaskIndex].imageUrl ? (
                                                            <img
                                                                src={timelineConfig.tasks[currentTaskIndex].imageUrl}
                                                                alt={timelineConfig.tasks[currentTaskIndex].content}
                                                                className="object-contain rounded-lg mb-4"
                                                                style={{ maxWidth: '200px', maxHeight: '200px' }}
                                                            />
                                                        ) : (
                                                            timelineConfig.tasks[currentTaskIndex].icon && iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex].icon)?.icon && (
                                                                <i
                                                                    data-lucide={iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex].icon).icon}
                                                                    className="text-indigo-600 mb-4"
                                                                    style={{ width: '80px', height: '80px' }}
                                                                ></i>
                                                            )
                                                        )}
                                                        <div
                                                            className="text-gray-800 text-center"
                                                            style={getFontStyle(activeTheme, 36)}
                                                        >
                                                            {timelineConfig.tasks[currentTaskIndex].content}
                                                        </div>
                                                        <div className="text-2xl text-gray-600 mt-4">
                                                            {timelineConfig.tasks[currentTaskIndex].duration} min
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="text-2xl text-gray-500">No current task</div>
                                                )}
                                            </div>

                                            {/* Transition Indicator - 3/5 width */}
                                            <div
                                                className="flex flex-col items-center justify-center"
                                                style={{ flex: '3' }}
                                            >
                                                {displaySettings.transitionType === 'mascot' ? (
                                                    <MascotRoad
                                                        taskDuration={timelineConfig.tasks[currentTaskIndex]?.duration || 30}
                                                        elapsed={elapsedInTask}
                                                        isPast={false}
                                                        isActive={true}
                                                        mascotImg={displaySettings.mascotImage}
                                                        roadWidth={displaySettings.width * 0.5}
                                                    />
                                                ) : (
                                                    <ProgressLine
                                                        taskDuration={timelineConfig.tasks[currentTaskIndex]?.duration || 30}
                                                        elapsed={elapsedInTask}
                                                        isPast={false}
                                                        isActive={true}
                                                        lineWidth={displaySettings.width * 0.5}
                                                    />
                                                )}
                                                <div className="mt-8 text-3xl font-bold text-gray-700">
                                                    {Math.max(0, Math.floor((timelineConfig.tasks[currentTaskIndex]?.duration || 0) - (elapsedInTask / 60)))} min remaining
                                                </div>
                                            </div>

                                            {/* Next Task - 1/5 width */}
                                            <div
                                                className={`flex flex-col items-center justify-center ${activeTheme.cardRounded} shadow-lg p-8`}
                                                style={{
                                                    flex: '1',
                                                    backgroundColor: activeTheme.cardBgColor,
                                                    border: `${activeTheme.cardBorderWidth} solid ${activeTheme.cardBorderColor}`
                                                }}
                                            >
                                                {timelineConfig.tasks[currentTaskIndex + 1] ? (
                                                    <>
                                                        <div className="text-sm font-semibold text-gray-500 mb-4">NEXT TASK</div>
                                                        {timelineConfig.tasks[currentTaskIndex + 1].type === 'image' && timelineConfig.tasks[currentTaskIndex + 1].imageUrl ? (
                                                            <img
                                                                src={timelineConfig.tasks[currentTaskIndex + 1].imageUrl}
                                                                alt={timelineConfig.tasks[currentTaskIndex + 1].content}
                                                                className="object-contain rounded-lg mb-4"
                                                                style={{ maxWidth: '150px', maxHeight: '150px' }}
                                                            />
                                                        ) : (
                                                            timelineConfig.tasks[currentTaskIndex + 1].icon && iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex + 1].icon)?.icon && (
                                                                <i
                                                                    data-lucide={iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex + 1].icon).icon}
                                                                    className="text-indigo-600 mb-4"
                                                                    style={{ width: '64px', height: '64px' }}
                                                                ></i>
                                                            )
                                                        )}
                                                        <div
                                                            className="text-gray-700 text-center"
                                                            style={getFontStyle(activeTheme, 28)}
                                                        >
                                                            {timelineConfig.tasks[currentTaskIndex + 1].content}
                                                        </div>
                                                        <div className="text-xl text-gray-500 mt-4">
                                                            {timelineConfig.tasks[currentTaskIndex + 1].duration} min
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="text-xl text-gray-400">All done!</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Bottom Banner */}
                                    {displaySettings.bottomBannerImage && (
                                        <div className="flex items-center justify-center py-4 bg-gradient-to-r from-purple-600 to-indigo-500">
                                            <img
                                                src={displaySettings.bottomBannerImage}
                                                alt="Bottom Banner"
                                                className="max-h-20 object-contain"
                                            />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        </div>
                    </div>
                );
            }

            // ADMIN PANEL
            const maxTasks = getMaxTasksForDisplay();
            const maxRows = getMaxRowsForDisplay();

            return (
                <div className="w-full min-h-screen bg-gray-100 overflow-y-auto">
                    <div className="bg-white shadow-lg p-4 flex items-center justify-between sticky top-0 z-20">
                        <div className="flex items-center gap-4">
                            <h1 className="text-2xl font-bold text-gray-800">Timeline Editor</h1>
                            {setupData.setupComplete && (
                                <span className="text-sm text-gray-600">
                                    {setupData.schoolName} - {setupData.className}
                                </span>
                            )}
                            <button
                                onClick={() => setShowTemplateModal(true)}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                            >
                                Save as Template
                            </button>
                            <button
                                onClick={() => setShowDisplaySettings(true)}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Display Settings
                            </button>
                            <button
                                onClick={() => setShowThemeSelector(true)}
                                className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 font-semibold"
                            >
                                <span className="text-lg">{getThemeEmoji()}</span>
                                <span>Change Theme</span>
                            </button>
                        </div>
                        <div className="flex items-center gap-3">
                            <button
                                onClick={() => setShowSetupWizard(true)}
                                className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                            >
                                Setup Info
                            </button>
                            <button
                                onClick={() => setIsAdmin(false)}
                                className="flex items-center gap-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
                            >
                                <i data-lucide="log-out" className="w-5 h-5 pointer-events-none"></i>
                                Exit Admin
                            </button>
                        </div>
                    </div>

                    {/* Layout editing mode banner */}
                    {isEditingLayout && (
                        <div className="bg-purple-100 border-l-4 border-purple-500 text-purple-700 p-4 m-4" role="alert">
                            <p className="font-bold">ðŸŽ¨ Layout Editing Mode Active</p>
                            <p>Scroll down to the "Edit Tasks" section below - you'll see width and height sliders under each task tile. The Live Preview above will update automatically as you adjust the sliders.</p>
                        </div>
                    )}

                    {/* Task overflow warning */}
                    {taskOverflowWarning && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4" role="alert">
                            <p className="font-bold">Display Width Exceeded!</p>
                            <p>You have {timelineConfig.tasks.length} tasks, but your current display can only show {maxTasks} tasks in {displaySettings.mode} mode.
                            Consider switching to multi-row mode or using a wider display.</p>
                        </div>
                    )}

                    {/* Display Settings Modal */}
                    {showDisplaySettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 w-[700px] shadow-2xl max-h-[90vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">Display Settings</h2>

                                <div className="space-y-6">
                                    {/* Display Mode */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-3">
                                            Display Mode
                                        </label>
                                        <div className="grid grid-cols-3 gap-3">
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, mode: 'horizontal' })}
                                                className={`p-4 border-2 rounded-lg ${displaySettings.mode === 'horizontal' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                            >
                                                <div className="font-bold">Horizontal</div>
                                                <div className="text-xs text-gray-600">Ultra-wide displays</div>
                                            </button>
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, mode: 'multi-row' })}
                                                className={`p-4 border-2 rounded-lg ${displaySettings.mode === 'multi-row' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                            >
                                                <div className="font-bold">Multi-Row</div>
                                                <div className="text-xs text-gray-600">Standard monitors</div>
                                            </button>
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, mode: 'auto-pan' })}
                                                className={`p-4 border-2 rounded-lg ${displaySettings.mode === 'auto-pan' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                            >
                                                <div className="font-bold">Auto-Pan</div>
                                                <div className="text-xs text-gray-600">Focus on current task</div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Rows setting (only for multi-row) */}
                                    {displaySettings.mode === 'multi-row' && (
                                        <>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Number of Rows: {displaySettings.rows} (Max: {maxRows})
                                                </label>
                                                <input
                                                    type="range"
                                                    value={displaySettings.rows}
                                                    onChange={(e) => setDisplaySettings({ ...displaySettings, rows: parseInt(e.target.value) })}
                                                    className="w-full"
                                                    min="1"
                                                    max={maxRows}
                                                    step="1"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-3">
                                                    Path Direction
                                                </label>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button
                                                        onClick={() => setDisplaySettings({ ...displaySettings, pathDirection: 'sequential' })}
                                                        className={`p-4 border-2 rounded-lg ${displaySettings.pathDirection === 'sequential' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                                    >
                                                        <div className="font-bold">Sequential</div>
                                                        <div className="text-xs text-gray-600">â†’ â†’ â†’<br/>â†’ â†’ â†’</div>
                                                    </button>
                                                    <button
                                                        onClick={() => setDisplaySettings({ ...displaySettings, pathDirection: 'snake' })}
                                                        className={`p-4 border-2 rounded-lg ${displaySettings.pathDirection === 'snake' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                                    >
                                                        <div className="font-bold">Snake</div>
                                                        <div className="text-xs text-gray-600">â†’ â†’ â†’<br/>â† â† â†</div>
                                                    </button>
                                                </div>
                                            </div>
                                        </>
                                    )}

                                    {/* Transition Type */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-3">
                                            Transition Indicator
                                        </label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, transitionType: 'progress-line' })}
                                                className={`p-4 border-2 rounded-lg ${displaySettings.transitionType === 'progress-line' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                            >
                                                <div className="font-bold">Progress Line</div>
                                                <div className="text-xs text-gray-600">Simple line with moving dot (like music players)</div>
                                            </button>
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, transitionType: 'mascot' })}
                                                className={`p-4 border-2 rounded-lg ${displaySettings.transitionType === 'mascot' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'}`}
                                            >
                                                <div className="font-bold">Road with Mascot</div>
                                                <div className="text-xs text-gray-600">Character travels along a road</div>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Mascot Upload */}
                                    {displaySettings.transitionType === 'mascot' && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Upload Class Mascot Image
                                            </label>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={handleMascotUpload}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            />
                                            {displaySettings.mascotImage && (
                                                <div className="mt-2">
                                                    <img src={displaySettings.mascotImage} alt="Mascot" className="w-16 h-16 object-contain" />
                                                </div>
                                            )}
                                            <p className="text-xs text-gray-500 mt-1">Default: ðŸš— (car emoji)</p>
                                        </div>
                                    )}

                                    {/* Banner Images for Auto-Pan Mode */}
                                    {displaySettings.mode === 'auto-pan' && (
                                        <>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Top Banner Image (Optional)
                                                </label>
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        if (file) {
                                                            const reader = new FileReader();
                                                            reader.onload = (event) => {
                                                                setDisplaySettings({ ...displaySettings, topBannerImage: event.target.result });
                                                            };
                                                            reader.readAsDataURL(file);
                                                        }
                                                    }}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                                />
                                                {displaySettings.topBannerImage && (
                                                    <div className="mt-2 flex items-center gap-2">
                                                        <img src={displaySettings.topBannerImage} alt="Top Banner" className="h-12 object-contain" />
                                                        <button
                                                            onClick={() => setDisplaySettings({ ...displaySettings, topBannerImage: null })}
                                                            className="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                )}
                                                <p className="text-xs text-gray-500 mt-1">Good for school logos or class names</p>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Bottom Banner Image (Optional)
                                                </label>
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        if (file) {
                                                            const reader = new FileReader();
                                                            reader.onload = (event) => {
                                                                setDisplaySettings({ ...displaySettings, bottomBannerImage: event.target.result });
                                                            };
                                                            reader.readAsDataURL(file);
                                                        }
                                                    }}
                                                    className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                                />
                                                {displaySettings.bottomBannerImage && (
                                                    <div className="mt-2 flex items-center gap-2">
                                                        <img src={displaySettings.bottomBannerImage} alt="Bottom Banner" className="h-12 object-contain" />
                                                        <button
                                                            onClick={() => setDisplaySettings({ ...displaySettings, bottomBannerImage: null })}
                                                            className="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                )}
                                                <p className="text-xs text-gray-500 mt-1">Good for decorative images or additional info</p>
                                            </div>

                                            <div className="flex items-center gap-2">
                                                <input
                                                    type="checkbox"
                                                    id="showClock"
                                                    checked={displaySettings.showClock}
                                                    onChange={(e) => setDisplaySettings({ ...displaySettings, showClock: e.target.checked })}
                                                    className="w-4 h-4"
                                                />
                                                <label htmlFor="showClock" className="text-sm text-gray-700">
                                                    Show live clock in banner area
                                                </label>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Task Tile Height: {displaySettings.autoPanTileHeight}% of display height
                                                </label>
                                                <input
                                                    type="range"
                                                    value={displaySettings.autoPanTileHeight}
                                                    onChange={(e) => setDisplaySettings({ ...displaySettings, autoPanTileHeight: parseInt(e.target.value) })}
                                                    className="w-full"
                                                    min="30"
                                                    max="80"
                                                    step="5"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Adjust to prevent interference with banner images</p>
                                            </div>
                                        </>
                                    )}

                                    {/* Common resolutions */}
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-3">
                                            Common Display Resolutions
                                        </label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, width: 2560, height: 1080 })}
                                                className="p-3 border-2 border-gray-300 rounded-lg hover:border-indigo-500 text-left"
                                            >
                                                <div className="font-bold">2560 Ã— 1080</div>
                                                <div className="text-xs text-gray-600">Ultra-wide 21:9</div>
                                            </button>
                                            <button
                                                onClick={() => setDisplaySettings({ ...displaySettings, width: 1920, height: 1080 })}
                                                className="p-3 border-2 border-gray-300 rounded-lg hover:border-indigo-500 text-left"
                                            >
                                                <div className="font-bold">1920 Ã— 1080</div>
                                                <div className="text-xs text-gray-600">Full HD 16:9</div>
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Width: {displaySettings.width}px
                                        </label>
                                        <input
                                            type="number"
                                            value={displaySettings.width}
                                            onChange={(e) => setDisplaySettings({ ...displaySettings, width: parseInt(e.target.value) || 1920 })}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            min="800"
                                            max="7680"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Height: {displaySettings.height}px
                                        </label>
                                        <input
                                            type="number"
                                            value={displaySettings.height}
                                            onChange={(e) => setDisplaySettings({ ...displaySettings, height: parseInt(e.target.value) || 1080 })}
                                            className="w-full p-3 border-2 border-gray-300 rounded-lg"
                                            min="600"
                                            max="2160"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Scale: {displaySettings.scale}%
                                        </label>
                                        <input
                                            type="range"
                                            value={displaySettings.scale}
                                            onChange={(e) => setDisplaySettings({ ...displaySettings, scale: parseInt(e.target.value) })}
                                            className="w-full"
                                            min="50"
                                            max="150"
                                            step="5"
                                        />
                                    </div>

                                    <div className="bg-indigo-50 p-4 rounded-lg">
                                        <div className="text-sm font-medium text-gray-700 mb-2">Display Capacity:</div>
                                        <div className="text-sm text-gray-600">
                                            <div><strong>Max Tasks:</strong> {maxTasks} tasks</div>
                                            <div><strong>Current Tasks:</strong> {timelineConfig.tasks.length} tasks</div>
                                            {timelineConfig.tasks.length > maxTasks && (
                                                <div className="text-red-600 font-bold mt-2">
                                                    âš ï¸ {timelineConfig.tasks.length - maxTasks} tasks exceed display capacity!
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => setShowDisplaySettings(false)}
                                        className="flex-1 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-semibold"
                                    >
                                        Save Settings
                                    </button>
                                    <button
                                        onClick={() => setShowDisplaySettings(false)}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Template Modal */}
                    {showTemplateModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 w-96 shadow-2xl">
                                <h2 className="text-2xl font-bold mb-6 text-gray-800">Save Current Schedule as Template</h2>
                                <input
                                    type="text"
                                    placeholder="Template Name (e.g., Monday Schedule)"
                                    value={newTemplateName}
                                    onChange={(e) => setNewTemplateName(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSaveAsTemplate()}
                                    className="w-full p-3 border border-gray-300 rounded-lg mb-6 text-lg"
                                />
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSaveAsTemplate}
                                        className="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold"
                                    >
                                        Save Template
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowTemplateModal(false);
                                            setNewTemplateName('');
                                        }}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-semibold"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Theme Selector Modal */}
                    {showThemeSelector && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-8">
                            <div className="bg-white rounded-lg p-8 w-full max-w-5xl shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-bold text-gray-800">Choose a Theme</h2>
                                    <button
                                        onClick={() => setShowThemeSelector(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <i data-lucide="x" className="w-8 h-8 pointer-events-none"></i>
                                    </button>
                                </div>

                                <h3 className="text-xl font-semibold text-gray-700 mb-4">Preset Themes</h3>
                                <div className="grid grid-cols-3 gap-4 mb-8">
                                    {Object.values(presetThemes).map(theme => (
                                        <div
                                            key={theme.id}
                                            onClick={() => {
                                                setCurrentTheme(theme.id);
                                                setShowThemeSelector(false);
                                            }}
                                            className={`relative cursor-pointer border-4 rounded-lg p-4 transition-all hover:shadow-xl ${
                                                currentTheme === theme.id ? 'border-indigo-600' : 'border-gray-300'
                                            }`}
                                        >
                                            {currentTheme === theme.id && (
                                                <div className="absolute top-2 right-2 bg-indigo-600 text-white rounded-full p-1">
                                                    <i data-lucide="check" className="w-5 h-5"></i>
                                                </div>
                                            )}
                                            <div className="text-4xl mb-2 text-center">{theme.emoji}</div>
                                            <div className="text-lg font-bold text-center mb-3">{theme.name}</div>
                                            <div
                                                className="h-20 rounded-lg mb-3"
                                                style={{
                                                    background: theme.bgGradientVia
                                                        ? `linear-gradient(to right, ${theme.bgGradientFrom}, ${theme.bgGradientVia}, ${theme.bgGradientTo})`
                                                        : `linear-gradient(to right, ${theme.bgGradientFrom}, ${theme.bgGradientTo})`
                                                }}
                                            ></div>
                                            <div
                                                className={`${theme.cardRounded} p-3 text-center text-sm font-semibold`}
                                                style={{
                                                    backgroundColor: theme.cardBgColor,
                                                    border: `${theme.cardBorderWidth} solid ${theme.cardBorderColor}`,
                                                    fontWeight: theme.fontWeight,
                                                    textTransform: theme.fontTransform
                                                }}
                                            >
                                                Sample Task
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {customThemes.length > 0 && (
                                    <>
                                        <h3 className="text-xl font-semibold text-gray-700 mb-4">Custom Themes</h3>
                                        <div className="grid grid-cols-3 gap-4 mb-8">
                                            {customThemes.map(theme => (
                                                <div
                                                    key={theme.id}
                                                    className={`relative border-4 rounded-lg p-4 transition-all ${
                                                        currentTheme === theme.id ? 'border-indigo-600' : 'border-gray-300'
                                                    }`}
                                                >
                                                    {currentTheme === theme.id && (
                                                        <div className="absolute top-2 right-2 bg-indigo-600 text-white rounded-full p-1">
                                                            <i data-lucide="check" className="w-5 h-5"></i>
                                                        </div>
                                                    )}
                                                    <div className="flex items-start justify-between mb-2">
                                                        <div className="text-4xl pointer-events-none">{theme.emoji}</div>
                                                        <div className="flex gap-1">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setEditingTheme({ ...theme });
                                                                    setShowThemeEditor(true);
                                                                }}
                                                                className="p-2 text-blue-600 hover:bg-blue-50 rounded cursor-pointer"
                                                                title="Edit"
                                                            >
                                                                <i data-lucide="edit" className="w-4 h-4 pointer-events-none"></i>
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (confirm(`Delete "${theme.name}"?`)) {
                                                                        setCustomThemes(customThemes.filter(t => t.id !== theme.id));
                                                                        if (currentTheme === theme.id) {
                                                                            setCurrentTheme('ocean-calm');
                                                                        }
                                                                    }
                                                                }}
                                                                className="p-2 text-red-600 hover:bg-red-50 rounded cursor-pointer"
                                                                title="Delete"
                                                            >
                                                                <i data-lucide="trash-2" className="w-4 h-4 pointer-events-none"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div
                                                        onClick={() => {
                                                            setCurrentTheme(theme.id);
                                                            setShowThemeSelector(false);
                                                        }}
                                                        className="cursor-pointer"
                                                    >
                                                        <div className="text-lg font-bold text-center mb-3">
                                                            {theme.name}
                                                            <span className="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">custom</span>
                                                        </div>
                                                        <div
                                                            className="h-20 rounded-lg mb-3"
                                                            style={{
                                                                background: theme.bgGradientVia
                                                                    ? `linear-gradient(to right, ${theme.bgGradientFrom}, ${theme.bgGradientVia}, ${theme.bgGradientTo})`
                                                                    : `linear-gradient(to right, ${theme.bgGradientFrom}, ${theme.bgGradientTo})`
                                                            }}
                                                        ></div>
                                                        <div
                                                            className={`${theme.cardRounded} p-3 text-center text-sm font-semibold`}
                                                            style={{
                                                                backgroundColor: theme.cardBgColor,
                                                                border: `${theme.cardBorderWidth} solid ${theme.cardBorderColor}`,
                                                                fontWeight: theme.fontWeight,
                                                                textTransform: theme.fontTransform
                                                            }}
                                                        >
                                                            Sample Task
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}

                                <button
                                    onClick={() => {
                                        const newTheme = {
                                            ...presetThemes['ocean-calm'],
                                            id: `custom-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                            name: `Custom Theme ${customThemes.length + 1}`,
                                            emoji: 'ðŸŽ¨'
                                        };
                                        setEditingTheme(newTheme);
                                        setShowThemeEditor(true);
                                        setShowThemeSelector(false);
                                    }}
                                    className="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 font-bold text-lg"
                                >
                                    <i data-lucide="plus" className="w-6 h-6 inline mr-2 pointer-events-none"></i>
                                    Create Custom Theme
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Theme Editor Modal */}
                    {showThemeEditor && editingTheme && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-lg w-full max-w-7xl h-[95vh] shadow-2xl flex flex-col">
                                {/* Header */}
                                <div className="flex justify-between items-center p-6 border-b">
                                    <h2 className="text-3xl font-bold text-gray-800">Custom Theme Editor</h2>
                                    <button
                                        onClick={() => {
                                            setShowThemeEditor(false);
                                            setEditingTheme(null);
                                        }}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <i data-lucide="x" className="w-8 h-8 pointer-events-none"></i>
                                    </button>
                                </div>

                                {/* Main Content */}
                                <div className="flex-1 flex overflow-hidden">
                                    {/* Left Panel - Controls */}
                                    <div className="w-1/2 overflow-y-auto p-6 border-r">
                                        {/* Theme Name */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Theme Name</label>
                                            <input
                                                type="text"
                                                value={editingTheme.name}
                                                onChange={(e) => setEditingTheme({ ...editingTheme, name: e.target.value })}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:outline-none"
                                                placeholder="My Custom Theme"
                                            />
                                        </div>

                                        {/* Theme Emoji */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Theme Emoji</label>
                                            <input
                                                type="text"
                                                value={editingTheme.emoji}
                                                onChange={(e) => setEditingTheme({ ...editingTheme, emoji: e.target.value })}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg text-4xl text-center focus:border-indigo-500 focus:outline-none"
                                                placeholder="ðŸŽ¨"
                                                inputMode="text"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Click to select or paste an emoji (Windows: Win+. | Mac: Cmd+Ctrl+Space)</p>
                                        </div>

                                        {/* Base Theme Template */}
                                        <div className="mb-6">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Start from Preset</label>
                                            <select
                                                onChange={(e) => {
                                                    const baseTheme = presetThemes[e.target.value];
                                                    setEditingTheme({
                                                        ...baseTheme,
                                                        id: editingTheme.id,
                                                        name: editingTheme.name,
                                                        emoji: editingTheme.emoji
                                                    });
                                                }}
                                                className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                                            >
                                                <option value="">Choose a preset to copy...</option>
                                                {Object.values(presetThemes).map(theme => (
                                                    <option key={theme.id} value={theme.id}>
                                                        {theme.emoji} {theme.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>

                                        <hr className="my-6" />

                                        {/* Background Gradient */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Background Gradient</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Start Color</label>
                                                    <input
                                                        type="color"
                                                        value={editingTheme.bgGradientFrom}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, bgGradientFrom: e.target.value })}
                                                        className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">End Color</label>
                                                    <input
                                                        type="color"
                                                        value={editingTheme.bgGradientTo}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, bgGradientTo: e.target.value })}
                                                        className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Task Card Styling */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Task Card Design</h3>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Corner Style</label>
                                                <select
                                                    value={editingTheme.cardRounded}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, cardRounded: e.target.value })}
                                                    className="w-full p-2 border-2 border-gray-300 rounded-lg"
                                                >
                                                    <option value="rounded-3xl">Extra Rounded</option>
                                                    <option value="rounded-2xl">Very Rounded</option>
                                                    <option value="rounded-xl">Rounded</option>
                                                    <option value="rounded-lg">Slightly Rounded</option>
                                                    <option value="rounded-md">Minimal Rounded</option>
                                                    <option value="rounded-sm">Sharp Corners</option>
                                                </select>
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Border Color</label>
                                                <input
                                                    type="color"
                                                    value={editingTheme.cardBorderColor}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, cardBorderColor: e.target.value })}
                                                    className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                />
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Border Width: {editingTheme.cardBorderWidth}</label>
                                                <input
                                                    type="range"
                                                    min="1"
                                                    max="6"
                                                    step="1"
                                                    value={parseInt(editingTheme.cardBorderWidth)}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, cardBorderWidth: `${e.target.value}px` })}
                                                    className="w-full"
                                                />
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Card Background</label>
                                                <input
                                                    type="color"
                                                    value={editingTheme.cardBgColor}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, cardBgColor: e.target.value })}
                                                    className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                />
                                            </div>
                                        </div>

                                        {/* Font Style */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Font Style</h3>
                                            <select
                                                value={`${editingTheme.fontWeight}-${editingTheme.fontTransform}-${editingTheme.fontFamily || 'sans-serif'}`}
                                                onChange={(e) => {
                                                    const parts = e.target.value.split('-');
                                                    const weight = parts[0];
                                                    const transform = parts[1];
                                                    const family = parts.slice(2).join('-');
                                                    setEditingTheme({
                                                        ...editingTheme,
                                                        fontWeight: weight,
                                                        fontTransform: transform,
                                                        fontFamily: family
                                                    });
                                                }}
                                                className="w-full p-2 border-2 border-gray-300 rounded-lg"
                                            >
                                                <option value="300-none-sans-serif">Light</option>
                                                <option value="400-none-sans-serif">Regular</option>
                                                <option value="500-none-sans-serif">Medium</option>
                                                <option value="700-none-sans-serif">Bold</option>
                                                <option value="800-none-sans-serif">Extra Bold</option>
                                                <option value="800-uppercase-sans-serif">Comic (Uppercase & Bold)</option>
                                                <option value="100-none-twinkl-looped">Twinkl Cursive Looped - Thin</option>
                                                <option value="300-none-twinkl-looped">Twinkl Cursive Looped - Light</option>
                                                <option value="400-none-twinkl-looped">Twinkl Cursive Looped - Regular</option>
                                                <option value="600-none-twinkl-looped">Twinkl Cursive Looped - Semibold</option>
                                                <option value="700-none-twinkl-looped">Twinkl Cursive Looped - Bold</option>
                                                <option value="100-none-twinkl-unlooped">Twinkl Cursive Unlooped - Thin</option>
                                                <option value="300-none-twinkl-unlooped">Twinkl Cursive Unlooped - Light</option>
                                                <option value="400-none-twinkl-unlooped">Twinkl Cursive Unlooped - Regular</option>
                                                <option value="600-none-twinkl-unlooped">Twinkl Cursive Unlooped - Semibold</option>
                                                <option value="700-none-twinkl-unlooped">Twinkl Cursive Unlooped - Bold</option>
                                                <option value="100-none-twinkl-precursive">Twinkl Precursive - Thin</option>
                                                <option value="300-none-twinkl-precursive">Twinkl Precursive - Light</option>
                                                <option value="400-none-twinkl-precursive">Twinkl Precursive - Regular</option>
                                                <option value="600-none-twinkl-precursive">Twinkl Precursive - Semibold</option>
                                                <option value="700-none-twinkl-precursive">Twinkl Precursive - Bold</option>
                                            </select>
                                        </div>

                                        {/* Current Task Highlight */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Current Task Highlight</h3>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Glow Color</label>
                                                <input
                                                    type="color"
                                                    value={editingTheme.currentGlowColor}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, currentGlowColor: e.target.value })}
                                                    className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                />
                                            </div>

                                            <div className="mb-4">
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Background Overlay</label>
                                                <input
                                                    type="color"
                                                    value={editingTheme.currentBgOverlay.match(/#[0-9a-f]{6}/i)?.[0] || '#ffffff'}
                                                    onChange={(e) => {
                                                        const opacity = editingTheme.currentBgOverlay.match(/[\d.]+\)$/)?.[0].replace(')', '') || '0.5';
                                                        setEditingTheme({ ...editingTheme, currentBgOverlay: `rgba(${parseInt(e.target.value.slice(1,3), 16)}, ${parseInt(e.target.value.slice(3,5), 16)}, ${parseInt(e.target.value.slice(5,7), 16)}, ${opacity})` });
                                                    }}
                                                    className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                />
                                            </div>

                                            <div className="mb-4">
                                                <label className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={editingTheme.currentBorderEnhance || false}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, currentBorderEnhance: e.target.checked })}
                                                        className="mr-2 w-5 h-5"
                                                    />
                                                    <span className="text-sm font-medium text-gray-700">Enhance Border on Current Task</span>
                                                </label>
                                            </div>
                                        </div>

                                        {/* Progress Line Colors */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Time Progress Colors</h3>
                                            <div className="grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-2">Past/Done</label>
                                                    <input
                                                        type="color"
                                                        value={editingTheme.tickPastColor}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, tickPastColor: e.target.value })}
                                                        className="w-full h-10 rounded border-2 border-gray-300 cursor-pointer"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-2">Current/Active</label>
                                                    <input
                                                        type="color"
                                                        value={editingTheme.tickCurrentColor}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, tickCurrentColor: e.target.value })}
                                                        className="w-full h-10 rounded border-2 border-gray-300 cursor-pointer"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-2">Future/Next</label>
                                                    <input
                                                        type="color"
                                                        value={editingTheme.tickFutureColor}
                                                        onChange={(e) => setEditingTheme({ ...editingTheme, tickFutureColor: e.target.value })}
                                                        className="w-full h-10 rounded border-2 border-gray-300 cursor-pointer"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Time Card Accent */}
                                        <div className="mb-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-3">Time Card Accents</h3>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                                                <input
                                                    type="color"
                                                    value={editingTheme.timeCardAccentColor}
                                                    onChange={(e) => setEditingTheme({ ...editingTheme, timeCardAccentColor: e.target.value })}
                                                    className="w-full h-12 rounded border-2 border-gray-300 cursor-pointer"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Right Panel - Live Preview */}
                                    <div className="w-1/2 overflow-y-auto p-6 bg-gray-50">
                                        <h3 className="text-2xl font-bold text-gray-800 mb-4">Live Preview</h3>

                                        {/* Background Preview */}
                                        <div className="mb-6">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Background</p>
                                            <div
                                                className="w-full h-32 rounded-lg shadow-inner"
                                                style={{
                                                    background: editingTheme.bgGradientVia
                                                        ? `linear-gradient(to right, ${editingTheme.bgGradientFrom}, ${editingTheme.bgGradientVia}, ${editingTheme.bgGradientTo})`
                                                        : `linear-gradient(to right, ${editingTheme.bgGradientFrom}, ${editingTheme.bgGradientTo})`
                                                }}
                                            ></div>
                                        </div>

                                        {/* Task Card Previews */}
                                        <div className="mb-6">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Task Cards</p>
                                            <div className="space-y-4">
                                                {/* Regular Task */}
                                                <div>
                                                    <p className="text-xs text-gray-600 mb-2">Regular Task:</p>
                                                    <div
                                                        className={`${editingTheme.cardRounded} p-4 shadow-lg`}
                                                        style={{
                                                            backgroundColor: editingTheme.cardBgColor,
                                                            border: `${editingTheme.cardBorderWidth} solid ${editingTheme.cardBorderColor}`
                                                        }}
                                                    >
                                                        <div
                                                            className="text-center text-gray-800"
                                                            style={getFontStyle(editingTheme, 14)}
                                                        >
                                                            Reading Time
                                                        </div>
                                                        <div className="text-center text-gray-600 text-sm mt-2">30 min</div>
                                                    </div>
                                                </div>

                                                {/* Current Task */}
                                                <div>
                                                    <p className="text-xs text-gray-600 mb-2">Current Task (Active):</p>
                                                    <div
                                                        className={`${editingTheme.cardRounded} p-4 shadow-2xl transform scale-105`}
                                                        style={{
                                                            backgroundColor: editingTheme.cardBgColor,
                                                            border: editingTheme.currentBorderEnhance
                                                                ? `${parseInt(editingTheme.cardBorderWidth) * 1.5}px solid ${editingTheme.currentGlowColor}`
                                                                : `${editingTheme.cardBorderWidth} solid ${editingTheme.cardBorderColor}`,
                                                            boxShadow: `0 0 20px ${editingTheme.currentGlowColor}`
                                                        }}
                                                    >
                                                        <div
                                                            className="text-center text-gray-800"
                                                            style={getFontStyle(editingTheme, 14)}
                                                        >
                                                            Math Activity
                                                        </div>
                                                        <div className="text-center text-gray-600 text-sm mt-2">45 min</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Progress Line Preview */}
                                        <div className="mb-6">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Progress Indicator</p>
                                            <div className="flex items-center gap-2">
                                                <div
                                                    className="w-8 h-8 rounded-full"
                                                    style={{ backgroundColor: editingTheme.tickPastColor }}
                                                ></div>
                                                <div
                                                    className="w-8 h-8 rounded-full"
                                                    style={{ backgroundColor: editingTheme.tickCurrentColor }}
                                                ></div>
                                                <div
                                                    className="w-8 h-8 rounded-full"
                                                    style={{ backgroundColor: editingTheme.tickFutureColor }}
                                                ></div>
                                                <span className="text-xs text-gray-600 ml-2">Past â†’ Current â†’ Future</span>
                                            </div>
                                        </div>

                                        {/* Time Cards Preview */}
                                        <div>
                                            <p className="text-sm font-medium text-gray-700 mb-2">Time Cards</p>
                                            <div className="flex gap-4">
                                                <div
                                                    className="flex-1 rounded-xl shadow-lg p-4 bg-white"
                                                    style={{
                                                        borderLeft: `4px solid ${editingTheme.timeCardAccentColor}`
                                                    }}
                                                >
                                                    <div
                                                        className="text-2xl font-bold text-center"
                                                        style={{ color: editingTheme.timeCardAccentColor }}
                                                    >
                                                        09:00
                                                    </div>
                                                    <div className="text-xs text-gray-600 text-center mt-1">Start</div>
                                                </div>
                                                <div
                                                    className="flex-1 rounded-xl shadow-lg p-4 bg-white"
                                                    style={{
                                                        borderLeft: `4px solid ${editingTheme.timeCardAccentColor}`
                                                    }}
                                                >
                                                    <div
                                                        className="text-2xl font-bold text-center"
                                                        style={{ color: editingTheme.timeCardAccentColor }}
                                                    >
                                                        15:00
                                                    </div>
                                                    <div className="text-xs text-gray-600 text-center mt-1">End</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="flex justify-between items-center p-6 border-t bg-gray-50">
                                    <button
                                        onClick={() => {
                                            setShowThemeEditor(false);
                                            setEditingTheme(null);
                                            setShowThemeSelector(true);
                                        }}
                                        className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!editingTheme.name.trim()) {
                                                alert('Please enter a theme name');
                                                return;
                                            }
                                            // Check if this is an existing custom theme (editing) or new
                                            const existingIndex = customThemes.findIndex(t => t.id === editingTheme.id);
                                            if (existingIndex >= 0) {
                                                // Update existing
                                                const updated = [...customThemes];
                                                updated[existingIndex] = editingTheme;
                                                setCustomThemes(updated);
                                            } else {
                                                // Add new
                                                setCustomThemes([...customThemes, editingTheme]);
                                            }
                                            setCurrentTheme(editingTheme.id);
                                            setShowThemeEditor(false);
                                            setEditingTheme(null);
                                        }}
                                        className="px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 font-bold text-lg"
                                    >
                                        Save & Apply Theme
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Timeline Configuration */}
                    <div className="p-6">
                        {/* Templates Section */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Saved Templates</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {templates.map(template => (
                                    <div
                                        key={template.id}
                                        className={`border-2 rounded-lg p-4 transition-all max-w-xs ${
                                            selectedTemplate === template.id
                                                ? 'border-indigo-500 bg-indigo-50'
                                                : 'border-gray-300 hover:border-indigo-300'
                                        }`}
                                    >
                                        <div className="flex items-start justify-between mb-3">
                                            <div>
                                                <h3 className="font-bold text-gray-800">{template.name}</h3>
                                                <p className="text-sm text-gray-600">
                                                    {template.startTime} - {template.endTime}
                                                </p>
                                                <p className="text-xs text-gray-500 mt-1">
                                                    {template.tasks.length} tasks
                                                </p>
                                            </div>
                                            {template.id !== 'default' && (
                                                <button
                                                    onClick={() => handleDeleteTemplate(template.id)}
                                                    className="p-2 text-red-500 hover:bg-red-50 rounded cursor-pointer"
                                                >
                                                    <i data-lucide="trash-2" className="w-4 h-4 pointer-events-none"></i>
                                                </button>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => handleLoadTemplate(template)}
                                            className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
                                        >
                                            Load Template
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Timeline Settings</h2>
                            <div className="flex gap-4 items-start">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                                    <input
                                        type="time"
                                        value={timelineConfig.startTime}
                                        onChange={(e) => setTimelineConfig({ ...timelineConfig, startTime: e.target.value })}
                                        className="p-3 border border-gray-300 rounded-lg text-lg"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                                    <div className="p-3 border border-gray-300 rounded-lg text-lg bg-gray-50 text-gray-700 font-semibold">
                                        {calculateEndTime()}
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">Calculated from start time + task durations</p>
                                </div>
                                <div className="ml-auto">
                                    <button
                                        onClick={handleAddTask}
                                        className="flex items-center gap-2 bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600"
                                    >
                                        <i data-lucide="plus" className="w-5 h-5 pointer-events-none"></i>
                                        Add Task
                                    </button>
                                </div>
                            </div>
                        </div>
                        {/* Editable Task List */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mt-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">
                                Edit Tasks (Pan to Navigate)
                                {isEditingLayout && (
                                    <span className="ml-3 px-3 py-1 bg-purple-600 text-white text-sm rounded-full">
                                        Layout Edit Mode Active - Use sliders below each task
                                    </span>
                                )}
                            </h2>
                            <div
                                ref={scrollContainerRef}
                                onMouseDown={handleMouseDown}
                                onMouseMove={handleMouseMove}
                                onMouseUp={handleMouseUp}
                                onMouseLeave={handleMouseUp}
                                className="overflow-x-auto cursor-grab active:cursor-grabbing"
                                style={{ userSelect: 'none' }}
                            >
                                <div className="flex items-center gap-6 p-8 min-w-max">
                                    <div className="flex flex-col items-center bg-indigo-50 rounded-lg p-4 min-w-[100px]">
                                        <i data-lucide="clock" className="w-8 h-8 text-indigo-600 mb-2"></i>
                                        <div className="text-2xl font-bold">{timelineConfig.startTime}</div>
                                    </div>

                                    {timelineConfig.tasks.map((task, index) => {
                                        const taskWidth = task.width || 200;
                                        const taskHeight = task.height || 160;
                                        const transitionWidth = taskWidth * 1.5;

                                        return (
                                            <Fragment key={task.id}>
                                                <div className="flex flex-col">
                                                    <div
                                                        className="flex flex-col bg-white border-2 border-gray-300 rounded-lg p-4"
                                                        style={{
                                                            minWidth: `${taskWidth}px`,
                                                            width: `${taskWidth}px`
                                                        }}
                                                    >
                                                        {/* Task Preview */}
                                                        {task.type === 'image' && task.imageUrl ? (
                                                            <img
                                                                src={task.imageUrl}
                                                                alt={task.content}
                                                                className="object-cover rounded mb-2 mx-auto"
                                                                style={{
                                                                    width: `${Math.min(taskWidth * 0.6, 96)}px`,
                                                                    height: `${Math.min(taskHeight * 0.6, 96)}px`
                                                                }}
                                                            />
                                                        ) : (
                                                            <>
                                                                {task.icon && iconLibrary.find(i => i.id === task.icon)?.icon && (
                                                                    <i
                                                                        data-lucide={iconLibrary.find(i => i.id === task.icon).icon}
                                                                        className="text-indigo-600 mx-auto mb-2"
                                                                        style={{ width: '48px', height: '48px' }}
                                                                    ></i>
                                                                )}
                                                                <div
                                                                    className="font-bold text-center mb-2"
                                                                    style={{ fontSize: `${Math.min(taskWidth / 10, 20)}px` }}
                                                                >
                                                                    {task.content}
                                                                </div>
                                                            </>
                                                        )}
                                                        <div className="text-sm text-gray-600 text-center mb-3">{task.duration} min</div>

                                                        {/* Action Buttons */}
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => handleEditTask(task)}
                                                                className="flex-1 p-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors cursor-pointer"
                                                                title="Edit Task"
                                                            >
                                                                <i data-lucide="edit-2" className="w-4 h-4 mx-auto pointer-events-none"></i>
                                                            </button>
                                                            <button
                                                                onClick={() => handleDeleteTask(task.id)}
                                                                className="flex-1 p-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors cursor-pointer"
                                                                title="Delete Task"
                                                            >
                                                                <i data-lucide="trash-2" className="w-4 h-4 mx-auto pointer-events-none"></i>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {/* Layout resize controls */}
                                                    {isEditingLayout && displaySettings.mode !== 'auto-pan' && (
                                                        <div className="mt-2 p-3 bg-purple-50 rounded-lg border border-purple-200">
                                                            <div className="space-y-2">
                                                                <div>
                                                                    <label className="text-xs font-medium text-purple-700">
                                                                        Width: {taskWidth}px
                                                                    </label>
                                                                    <input
                                                                        type="range"
                                                                        min="120"
                                                                        max="400"
                                                                        step="10"
                                                                        value={taskWidth}
                                                                        onChange={(e) => handleUpdateTaskSize(task.id, parseInt(e.target.value), taskHeight)}
                                                                        className="w-full"
                                                                    />
                                                                </div>
                                                                <div>
                                                                    <label className="text-xs font-medium text-purple-700">
                                                                        Height: {taskHeight}px
                                                                    </label>
                                                                    <input
                                                                        type="range"
                                                                        min="100"
                                                                        max="300"
                                                                        step="10"
                                                                        value={taskHeight}
                                                                        onChange={(e) => handleUpdateTaskSize(task.id, taskWidth, parseInt(e.target.value))}
                                                                        className="w-full"
                                                                    />
                                                                </div>
                                                                <div className="text-xs text-purple-600 mt-1">
                                                                    Transition width: {transitionWidth.toFixed(0)}px
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="flex flex-col items-center justify-center bg-gray-50 rounded-lg p-4">
                                                    <div className="text-xs text-gray-600 mb-2 font-medium">
                                                        Transition Preview
                                                    </div>
                                                    {displaySettings.transitionType === 'mascot' ? (
                                                        <div className="w-full h-8 bg-gray-400 rounded-full relative overflow-hidden">
                                                            <div className="absolute inset-0 flex items-center justify-around">
                                                                {Array.from({ length: 6 }).map((_, i) => (
                                                                    <div key={i} className="w-3 h-0.5 bg-white rounded-full" />
                                                                ))}
                                                            </div>
                                                            <div className="absolute left-2 top-1/2 -translate-y-1/2 text-xl">ðŸš—</div>
                                                        </div>
                                                    ) : (
                                                        <div className="w-full h-3 bg-gray-300 rounded-full relative overflow-hidden">
                                                            <div className="absolute inset-0 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full w-1/2"></div>
                                                            <div className="absolute left-1/2 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-4 bg-white border-2 border-blue-600 rounded-full"></div>
                                                        </div>
                                                    )}
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Width: {transitionWidth.toFixed(0)}px
                                                    </div>
                                                </div>
                                            </Fragment>
                                        );
                                    })}

                                    <div className="flex flex-col items-center bg-red-50 rounded-lg p-4 min-w-[100px]">
                                        <i data-lucide="clock" className="w-8 h-8 text-red-600 mb-2"></i>
                                        <div className="text-2xl font-bold">{calculateEndTime()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        {/* Live Display Preview */}
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">
                                Live Display Preview - What Students See
                                <span className="ml-3 text-sm font-normal text-gray-600">
                                    (Scaled to {displaySettings.width}x{displaySettings.height} at {displaySettings.scale}% zoom)
                                </span>
                            </h2>
                            <div
                                className="border-2 border-gray-300 rounded-lg overflow-x-auto overflow-y-hidden bg-gray-200 p-4 flex justify-center items-center"
                                style={{
                                    height: `${(displaySettings.height * scaleFactor * Math.min(1, 1200 / (displaySettings.width * scaleFactor))) + 40}px`
                                }}
                            >
                                <div
                                    className="relative border-4 border-red-500 shadow-xl"
                                    style={{
                                        background: getActiveTheme().bgGradientVia
                                            ? `linear-gradient(to bottom, ${getActiveTheme().bgGradientFrom}, ${getActiveTheme().bgGradientVia}, ${getActiveTheme().bgGradientTo})`
                                            : `linear-gradient(to bottom, ${getActiveTheme().bgGradientFrom}, ${getActiveTheme().bgGradientTo})`,
                                        width: `${displaySettings.width * scaleFactor}px`,
                                        height: `${displaySettings.height * scaleFactor}px`,
                                        transform: `scale(${Math.min(1, 1200 / (displaySettings.width * scaleFactor))})`,
                                        transformOrigin: 'center center'
                                    }}
                                >
                                    {displaySettings.mode === 'horizontal' ? (
                                        <div className="w-full h-full flex items-center justify-center px-12">
                                            <div className="flex items-center gap-6">
                                                <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-6 min-w-[140px]" style={{ borderLeft: `6px solid ${getActiveTheme().timeCardAccentColor}` }}>
                                                    <i data-lucide="clock" className="w-12 h-12 mb-3" style={{ color: getActiveTheme().timeCardAccentColor }}></i>
                                                    <div className="text-5xl font-bold text-gray-800">{timelineConfig.startTime}</div>
                                                    <div className="text-lg text-gray-600 mt-2">Start</div>
                                                </div>

                                                {timelineConfig.tasks.map((task, index) => {
                                                    const isCurrentTask = index === currentTaskIndex;
                                                    const isPastTask = index < currentTaskIndex;
                                                    const taskWidth = task.width || 200;
                                                    const taskHeight = task.height || 160;
                                                    const transitionWidth = taskWidth * 1.5;
                                                    const previewTheme = getActiveTheme();
                                                    const taskCardBorder = previewTheme.cardBorderColorAlt && index % 2 === 1
                                                        ? previewTheme.cardBorderColorAlt
                                                        : previewTheme.cardBorderColor;

                                                    return (
                                                        <Fragment key={task.id}>
                                                            <div
                                                                className={`flex flex-col items-center justify-center ${previewTheme.cardRounded} shadow-lg p-6 transition-all duration-1000 ${isPastTask ? 'opacity-60' : ''} ${isCurrentTask ? 'scale-105' : ''}`}
                                                                style={{
                                                                    minWidth: `${taskWidth}px`,
                                                                    width: `${taskWidth}px`,
                                                                    minHeight: `${taskHeight}px`,
                                                                    backgroundColor: isPastTask ? '#f3f4f6' : previewTheme.cardBgColor,
                                                                    border: isCurrentTask && previewTheme.currentBorderEnhance
                                                                        ? `${parseInt(previewTheme.cardBorderWidth) * 1.5}px solid ${previewTheme.currentGlowColor}`
                                                                        : `${previewTheme.cardBorderWidth} solid ${taskCardBorder}`,
                                                                    boxShadow: isCurrentTask ? `0 0 30px ${previewTheme.currentGlowColor}` : undefined
                                                                }}
                                                            >
                                                                {task.type === 'image' && task.imageUrl ? (
                                                                    <img
                                                                        src={task.imageUrl}
                                                                        alt={task.content}
                                                                        className="object-cover rounded-lg mb-3"
                                                                        style={{
                                                                            width: `${Math.min(taskWidth * 0.7, 128)}px`,
                                                                            height: `${Math.min(taskHeight * 0.6, 128)}px`
                                                                        }}
                                                                    />
                                                                ) : (
                                                                    <>
                                                                        {task.icon && iconLibrary.find(i => i.id === task.icon)?.icon && (
                                                                            <i
                                                                                data-lucide={iconLibrary.find(i => i.id === task.icon).icon}
                                                                                className="text-indigo-600 mb-3"
                                                                                style={{ width: `${Math.min(taskWidth * 0.5, 80)}px`, height: `${Math.min(taskWidth * 0.5, 80)}px` }}
                                                                            ></i>
                                                                        )}
                                                                        <div
                                                                            className="text-gray-800 text-center mb-3"
                                                                            style={getFontStyle(previewTheme, Math.min(taskWidth / 5, 36))}
                                                                        >
                                                                            {task.content}
                                                                        </div>
                                                                    </>
                                                                )}
                                                                <div
                                                                    className="text-gray-600"
                                                                    style={{ fontSize: `${Math.min(taskWidth / 10, 20)}px` }}
                                                                >
                                                                    {task.duration} min
                                                                </div>
                                                            </div>

                                                            {displaySettings.transitionType === 'mascot' ? (
                                                                <MascotRoad
                                                                    taskDuration={task.duration}
                                                                    elapsed={isCurrentTask ? elapsedInTask : 0}
                                                                    isPast={isPastTask}
                                                                    isActive={isCurrentTask}
                                                                    mascotImg={displaySettings.mascotImage}
                                                                    roadWidth={transitionWidth}
                                                                />
                                                            ) : (
                                                                <ProgressLine
                                                                    taskDuration={task.duration}
                                                                    elapsed={isCurrentTask ? elapsedInTask : 0}
                                                                    isPast={isPastTask}
                                                                    isActive={isCurrentTask}
                                                                    lineWidth={transitionWidth}
                                                                />
                                                            )}
                                                        </Fragment>
                                                    );
                                                })}

                                                <div className="flex flex-col items-center justify-center bg-white rounded-2xl shadow-lg p-6 min-w-[140px]" style={{ borderLeft: `6px solid ${getActiveTheme().timeCardAccentColorAlt || getActiveTheme().timeCardAccentColor}` }}>
                                                    <i data-lucide="clock" className="w-12 h-12 mb-3" style={{ color: getActiveTheme().timeCardAccentColorAlt || getActiveTheme().timeCardAccentColor }}></i>
                                                    <div className="text-5xl font-bold text-gray-800">{calculateEndTime()}</div>
                                                    <div className="text-lg text-gray-600 mt-2">End</div>
                                                </div>
                                            </div>
                                        </div>
                                    ) : displaySettings.mode === 'multi-row' ? (
                                        <div className="w-full h-full flex flex-col justify-evenly">
                                            {Array.from({ length: displaySettings.rows }).map((_, rowIndex) => {
                                                const tasksPerRow = Math.ceil(timelineConfig.tasks.length / displaySettings.rows);
                                                const startIdx = rowIndex * tasksPerRow;
                                                const endIdx = Math.min((rowIndex + 1) * tasksPerRow, timelineConfig.tasks.length);

                                                if (startIdx >= timelineConfig.tasks.length) return null;

                                                return renderTimelineRow(timelineConfig.tasks, startIdx, endIdx, rowIndex);
                                            })}
                                        </div>
                                    ) : (
                                        /* Auto-Pan Mode Preview */
                                        <div className="w-full h-full flex flex-col">
                                            {/* Top Banner */}
                                            {(displaySettings.topBannerImage || displaySettings.showClock) && (
                                                <div className="flex items-center justify-center py-2 bg-gradient-to-r from-indigo-500 to-purple-600">
                                                    {displaySettings.topBannerImage && (
                                                        <img src={displaySettings.topBannerImage} alt="Top Banner" className="max-h-12 object-contain" />
                                                    )}
                                                    {displaySettings.showClock && (
                                                        <div className="text-2xl font-bold text-white ml-4">
                                                            {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Main Task Display Area - Current, Transition, Next */}
                                            <div className="flex-1 flex items-center justify-center px-4">
                                                <div className="w-full flex items-stretch gap-2" style={{ height: `${displaySettings.autoPanTileHeight}%` }}>
                                                    {/* Current Task - 1/5 width */}
                                                    <div className="flex flex-col items-center justify-center rounded-xl shadow-xl p-4 bg-gradient-to-br from-blue-100 to-blue-200 border-4 border-blue-400" style={{ flex: '1' }}>
                                                        {timelineConfig.tasks[currentTaskIndex] ? (
                                                            <>
                                                                <div className="text-xs font-semibold text-blue-600 mb-2">CURRENT TASK</div>
                                                                {timelineConfig.tasks[currentTaskIndex].type === 'image' && timelineConfig.tasks[currentTaskIndex].imageUrl ? (
                                                                    <img
                                                                        src={timelineConfig.tasks[currentTaskIndex].imageUrl}
                                                                        alt={timelineConfig.tasks[currentTaskIndex].content}
                                                                        className="object-contain rounded-lg mb-2"
                                                                        style={{ maxWidth: '80px', maxHeight: '80px' }}
                                                                    />
                                                                ) : (
                                                                    timelineConfig.tasks[currentTaskIndex].icon && iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex].icon)?.icon && (
                                                                        <i
                                                                            data-lucide={iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex].icon).icon}
                                                                            className="text-indigo-600 mb-2"
                                                                            style={{ width: '40px', height: '40px' }}
                                                                        ></i>
                                                                    )
                                                                )}
                                                                <div className="text-xl font-bold text-gray-800 text-center">
                                                                    {timelineConfig.tasks[currentTaskIndex].content}
                                                                </div>
                                                                <div className="text-sm text-gray-600 mt-2">
                                                                    {timelineConfig.tasks[currentTaskIndex].duration} min
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div className="text-sm text-gray-500">No current task</div>
                                                        )}
                                                    </div>

                                                    {/* Transition Indicator - 3/5 width */}
                                                    <div className="flex flex-col items-center justify-center" style={{ flex: '3' }}>
                                                        {displaySettings.transitionType === 'mascot' ? (
                                                            <MascotRoad
                                                                taskDuration={timelineConfig.tasks[currentTaskIndex]?.duration || 30}
                                                                elapsed={elapsedInTask}
                                                                isPast={false}
                                                                isActive={true}
                                                                mascotImg={displaySettings.mascotImage}
                                                                roadWidth={displaySettings.width * scaleFactor * 0.5}
                                                            />
                                                        ) : (
                                                            <ProgressLine
                                                                taskDuration={timelineConfig.tasks[currentTaskIndex]?.duration || 30}
                                                                elapsed={elapsedInTask}
                                                                isPast={false}
                                                                isActive={true}
                                                                lineWidth={displaySettings.width * scaleFactor * 0.5}
                                                            />
                                                        )}
                                                        <div className="mt-4 text-lg font-bold text-gray-700">
                                                            {Math.max(0, Math.floor((timelineConfig.tasks[currentTaskIndex]?.duration || 0) - (elapsedInTask / 60)))} min remaining
                                                        </div>
                                                    </div>

                                                    {/* Next Task - 1/5 width */}
                                                    <div className="flex flex-col items-center justify-center rounded-xl shadow-lg p-4 bg-white border-2 border-gray-300" style={{ flex: '1' }}>
                                                        {timelineConfig.tasks[currentTaskIndex + 1] ? (
                                                            <>
                                                                <div className="text-xs font-semibold text-gray-500 mb-2">NEXT TASK</div>
                                                                {timelineConfig.tasks[currentTaskIndex + 1].type === 'image' && timelineConfig.tasks[currentTaskIndex + 1].imageUrl ? (
                                                                    <img
                                                                        src={timelineConfig.tasks[currentTaskIndex + 1].imageUrl}
                                                                        alt={timelineConfig.tasks[currentTaskIndex + 1].content}
                                                                        className="object-contain rounded-lg mb-2"
                                                                        style={{ maxWidth: '60px', maxHeight: '60px' }}
                                                                    />
                                                                ) : (
                                                                    timelineConfig.tasks[currentTaskIndex + 1].icon && iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex + 1].icon)?.icon && (
                                                                        <i
                                                                            data-lucide={iconLibrary.find(i => i.id === timelineConfig.tasks[currentTaskIndex + 1].icon).icon}
                                                                            className="text-indigo-600 mb-2"
                                                                            style={{ width: '32px', height: '32px' }}
                                                                        ></i>
                                                                    )
                                                                )}
                                                                <div className="text-lg font-bold text-gray-700 text-center">
                                                                    {timelineConfig.tasks[currentTaskIndex + 1].content}
                                                                </div>
                                                                <div className="text-xs text-gray-500 mt-2">
                                                                    {timelineConfig.tasks[currentTaskIndex + 1].duration} min
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <div className="text-sm text-gray-400">All done!</div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bottom Banner */}
                                            {displaySettings.bottomBannerImage && (
                                                <div className="flex items-center justify-center py-2 bg-gradient-to-r from-purple-600 to-indigo-500">
                                                    <img src={displaySettings.bottomBannerImage} alt="Bottom Banner" className="max-h-12 object-contain" />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Instructions */}
                        <div className="mt-6 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <h3 className="font-bold text-blue-900 mb-2">Admin Instructions</h3>
                            <ul className="text-blue-800 space-y-1 text-sm">
                                <li>â€¢ Click the edit (pencil) button on any task to open the editor</li>
                                <li>â€¢ <strong>NEW:</strong> Resize individual tiles using the sliders below each task - transition indicators and road lengths adjust automatically!</li>
                                <li>â€¢ <strong>NEW:</strong> Choose between "Progress Line" (music player style) or "Road with Mascot" transition indicators</li>
                                <li>â€¢ Timeline automatically adjusts to your display width - excess tasks will trigger a warning</li>
                                <li>â€¢ Progress indicators animate smoothly in real-time</li>
                                <li>â€¢ Multi-row mode lets you use standard TVs/monitors instead of ultra-wide displays</li>
                                <li>â€¢ Snake path mode creates a continuous reading pattern across rows</li>
                            </ul>
                        </div>

                        {/* Task Edit Modal */}
                        {showTaskEditModal && editingTask && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                    <div className="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                                        <h2 className="text-2xl font-bold text-gray-800">Edit Task</h2>
                                    </div>

                                    <div className="p-6 space-y-6">
                                        {/* Task Name */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Task Name
                                            </label>
                                            <input
                                                type="text"
                                                value={editingTask.content}
                                                onChange={(e) => setEditingTask({ ...editingTask, content: e.target.value })}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="Enter task name"
                                            />
                                        </div>

                                        {/* Duration */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Duration (minutes)
                                            </label>
                                            <input
                                                type="number"
                                                value={editingTask.duration}
                                                onChange={(e) => setEditingTask({ ...editingTask, duration: parseInt(e.target.value) || 0 })}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                placeholder="Enter duration in minutes"
                                                min="1"
                                            />
                                        </div>

                                        {/* Icon Selection */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-3">
                                                Select Icon (Optional)
                                            </label>
                                            <div className="grid grid-cols-6 gap-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                                                {iconLibrary.map(iconItem => (
                                                    <button
                                                        key={iconItem.id}
                                                        onClick={() => setEditingTask({ ...editingTask, icon: iconItem.id })}
                                                        className={`p-4 rounded-lg border-2 hover:bg-purple-50 transition-colors flex flex-col items-center justify-center gap-2 ${
                                                            editingTask.icon === iconItem.id ? 'border-purple-500 bg-purple-100' : 'border-gray-200'
                                                        }`}
                                                        title={iconItem.name}
                                                        type="button"
                                                    >
                                                        <i data-lucide={iconItem.icon} className="w-8 h-8 text-indigo-600"></i>
                                                        <span className="text-xs text-gray-600 text-center">{iconItem.name}</span>
                                                    </button>
                                                ))}
                                            </div>
                                            {editingTask.icon && (
                                                <button
                                                    onClick={() => setEditingTask({ ...editingTask, icon: null })}
                                                    className="mt-3 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                    type="button"
                                                >
                                                    Remove Icon
                                                </button>
                                            )}
                                        </div>

                                        {/* Image Upload */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Upload Image (Optional)
                                            </label>
                                            {editingTask.imageUrl && editingTask.imageUrl !== '' ? (
                                                <div className="space-y-3">
                                                    <div className="flex items-start gap-3">
                                                        <img
                                                            src={editingTask.imageUrl}
                                                            alt="Task preview"
                                                            className="w-40 h-40 object-contain rounded-lg border-2 border-gray-300 bg-gray-50"
                                                        />
                                                        <div className="flex-1">
                                                            <p className="text-xs text-gray-600 mb-2">
                                                                Image will be displayed in the task card. Large images may slow down the app.
                                                            </p>
                                                            <button
                                                                onClick={() => setEditingTask({ ...editingTask, imageUrl: null, type: 'text' })}
                                                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
                                                                type="button"
                                                            >
                                                                Remove Image
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div>
                                                    <label className="flex items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 cursor-pointer transition-colors">
                                                        <div className="text-center">
                                                            <i data-lucide="image-plus" className="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                                            <span className="text-sm text-gray-600 block mb-1">Click to upload image</span>
                                                            <span className="text-xs text-gray-500">Recommended: Under 500KB for best performance</span>
                                                        </div>
                                                        <input
                                                            type="file"
                                                            accept="image/*"
                                                            onChange={(e) => {
                                                                const file = e.target.files[0];
                                                                if (file) {
                                                                    // Check file size (2MB limit)
                                                                    const maxSize = 2 * 1024 * 1024; // 2MB in bytes
                                                                    const warningSize = 500 * 1024; // 500KB in bytes

                                                                    if (file.size > maxSize) {
                                                                        alert(`Image is too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Please use an image smaller than 2MB.`);
                                                                        e.target.value = '';
                                                                        return;
                                                                    }

                                                                    if (file.size > warningSize) {
                                                                        const sizeInKB = (file.size / 1024).toFixed(0);
                                                                        if (!confirm(`This image is ${sizeInKB}KB. Large images may slow down the app. Consider using a smaller image for better performance. Continue anyway?`)) {
                                                                            e.target.value = '';
                                                                            return;
                                                                        }
                                                                    }

                                                                    const reader = new FileReader();
                                                                    reader.onload = (event) => {
                                                                        setEditingTask({
                                                                            ...editingTask,
                                                                            imageUrl: event.target.result,
                                                                            type: 'image'
                                                                        });
                                                                    };
                                                                    reader.readAsDataURL(file);
                                                                }
                                                            }}
                                                            className="hidden"
                                                        />
                                                    </label>
                                                    <p className="text-xs text-gray-500 mt-2">
                                                        Maximum file size: 2MB. Images will be stored as base64 data.
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Modal Footer */}
                                    <div className="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-6 flex gap-3 justify-end">
                                        <button
                                            onClick={handleCancelEdit}
                                            className="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-semibold"
                                            type="button"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSaveTaskFromModal}
                                            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
                                            type="button"
                                        >
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TimelineTaskSystem />);
    </script>
</body>
</html>
